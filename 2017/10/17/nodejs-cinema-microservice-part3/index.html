<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>ç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡å¹¶éƒ¨ç½²åˆ° docker ä¸Š â€” Part 3 | Z - Computer &amp; Programming Technology</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="å¤§å®¶å¥½ï¼Œæœ¬æ–‡æ˜¯ã€Œä½¿ç”¨ NodeJS æ„å»ºå½±é™¢å¾®æœåŠ¡ã€ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡æ–‡ç« ã€‚æ­¤ç³»åˆ—æ–‡ç« æ—¨åœ¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨ ES6ï¼ŒÂ¿ES7 â€¦8?ï¼Œå’Œ expressjs æ„å»ºä¸€ä¸ª API åº”ç”¨ï¼Œå¦‚ä½•è¿æ¥ MongoDB é›†ç¾¤ï¼Œæ€æ ·å°†å…¶éƒ¨ç½²äº docker å®¹å™¨ä¸­ï¼Œä»¥åŠæ¨¡æ‹Ÿå¾®æœåŠ¡è¿è¡Œäºäº‘ç¯å¢ƒä¸­çš„æƒ…å†µã€‚

## ä»¥å¾€ç« èŠ‚å¿«é€Ÿå›é¡¾
æˆ‘ä»¬è®²äº†ä»€ä¹ˆæ˜¯å¾®æœåŠ¡ï¼Œæ¢è®¨äº†å¾®æœåŠ¡çš„åˆ©ä¸å¼Š
æˆ‘ä»¬å®šä¹‰äº†å½±é™¢å¾®æœåŠ¡æ¶æ„
æˆ‘ä»¬è®¾è®¡å¹¶å®ç°äº†ç”µå½±">
<meta property="og:type" content="article">
<meta property="og:title" content="ç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡å¹¶éƒ¨ç½²åˆ° docker ä¸Š â€” Part 3">
<meta property="og:url" content="http://log.zvz.im/2017/10/17/nodejs-cinema-microservice-part3/index.html">
<meta property="og:site_name" content="Z - Computer & Programming Technology">
<meta property="og:description" content="å¤§å®¶å¥½ï¼Œæœ¬æ–‡æ˜¯ã€Œä½¿ç”¨ NodeJS æ„å»ºå½±é™¢å¾®æœåŠ¡ã€ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡æ–‡ç« ã€‚æ­¤ç³»åˆ—æ–‡ç« æ—¨åœ¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨ ES6ï¼ŒÂ¿ES7 â€¦8?ï¼Œå’Œ expressjs æ„å»ºä¸€ä¸ª API åº”ç”¨ï¼Œå¦‚ä½•è¿æ¥ MongoDB é›†ç¾¤ï¼Œæ€æ ·å°†å…¶éƒ¨ç½²äº docker å®¹å™¨ä¸­ï¼Œä»¥åŠæ¨¡æ‹Ÿå¾®æœåŠ¡è¿è¡Œäºäº‘ç¯å¢ƒä¸­çš„æƒ…å†µã€‚

## ä»¥å¾€ç« èŠ‚å¿«é€Ÿå›é¡¾
æˆ‘ä»¬è®²äº†ä»€ä¹ˆæ˜¯å¾®æœåŠ¡ï¼Œæ¢è®¨äº†å¾®æœåŠ¡çš„åˆ©ä¸å¼Š
æˆ‘ä»¬å®šä¹‰äº†å½±é™¢å¾®æœåŠ¡æ¶æ„
æˆ‘ä»¬è®¾è®¡å¹¶å®ç°äº†ç”µå½±">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/5201f3beb0ad3a8e.png">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/eac76015e41c1aa8.png">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/82a13f9a82e55315.png">
<meta property="og:updated_time" content="2024-05-12T13:15:10.157Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡å¹¶éƒ¨ç½²åˆ° docker ä¸Š â€” Part 3">
<meta name="twitter:description" content="å¤§å®¶å¥½ï¼Œæœ¬æ–‡æ˜¯ã€Œä½¿ç”¨ NodeJS æ„å»ºå½±é™¢å¾®æœåŠ¡ã€ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡æ–‡ç« ã€‚æ­¤ç³»åˆ—æ–‡ç« æ—¨åœ¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨ ES6ï¼ŒÂ¿ES7 â€¦8?ï¼Œå’Œ expressjs æ„å»ºä¸€ä¸ª API åº”ç”¨ï¼Œå¦‚ä½•è¿æ¥ MongoDB é›†ç¾¤ï¼Œæ€æ ·å°†å…¶éƒ¨ç½²äº docker å®¹å™¨ä¸­ï¼Œä»¥åŠæ¨¡æ‹Ÿå¾®æœåŠ¡è¿è¡Œäºäº‘ç¯å¢ƒä¸­çš„æƒ…å†µã€‚

## ä»¥å¾€ç« èŠ‚å¿«é€Ÿå›é¡¾
æˆ‘ä»¬è®²äº†ä»€ä¹ˆæ˜¯å¾®æœåŠ¡ï¼Œæ¢è®¨äº†å¾®æœåŠ¡çš„åˆ©ä¸å¼Š
æˆ‘ä»¬å®šä¹‰äº†å½±é™¢å¾®æœåŠ¡æ¶æ„
æˆ‘ä»¬è®¾è®¡å¹¶å®ç°äº†ç”µå½±">
<meta name="twitter:image" content="https://img.zvz.im/imgs/2019/06/5201f3beb0ad3a8e.png">
  
    <link rel="alternative" href="/atom.xml" title="Z - Computer &amp; Programming Technology" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.geekzu.org/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8NRBEZPWYN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8NRBEZPWYN');
</script>


  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-8768699638326268",
      enable_page_level_ads: true
    });
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <div class="outer">
        <section id="main"><article id="post-nodejs-cinema-microservice-part3" class="article article-type-post" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡å¹¶éƒ¨ç½²åˆ° docker ä¸Š â€” Part 3
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/10/17/nodejs-cinema-microservice-part3/" class="article-date">
  <time datetime="2017-10-17T14:39:51.000Z" itemprop="datePublished">2017-10-17</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/tags/Nodejs/">Nodejs</a>
  </div>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>å¤§å®¶å¥½ï¼Œæœ¬æ–‡æ˜¯ã€Œä½¿ç”¨ NodeJS æ„å»ºå½±é™¢å¾®æœåŠ¡ã€ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡æ–‡ç« ã€‚æ­¤ç³»åˆ—æ–‡ç« æ—¨åœ¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨ ES6ï¼ŒÂ¿ES7 â€¦8?ï¼Œå’Œ expressjs æ„å»ºä¸€ä¸ª API åº”ç”¨ï¼Œå¦‚ä½•è¿æ¥ MongoDB é›†ç¾¤ï¼Œæ€æ ·å°†å…¶éƒ¨ç½²äº docker å®¹å™¨ä¸­ï¼Œä»¥åŠæ¨¡æ‹Ÿå¾®æœåŠ¡è¿è¡Œäºäº‘ç¯å¢ƒä¸­çš„æƒ…å†µã€‚</p>
</blockquote>
<h3 id="ä»¥å¾€ç« èŠ‚å¿«é€Ÿå›é¡¾"><a href="#ä»¥å¾€ç« èŠ‚å¿«é€Ÿå›é¡¾" class="headerlink" title="## ä»¥å¾€ç« èŠ‚å¿«é€Ÿå›é¡¾"></a>## ä»¥å¾€ç« èŠ‚å¿«é€Ÿå›é¡¾</h3><ul>
<li>æˆ‘ä»¬è®²äº†<strong>ä»€ä¹ˆæ˜¯å¾®æœåŠ¡</strong>ï¼Œæ¢è®¨äº†<strong>å¾®æœåŠ¡</strong>çš„<strong>åˆ©</strong>ä¸<strong>å¼Š</strong></li>
<li>æˆ‘ä»¬å®šä¹‰äº†<strong>å½±é™¢å¾®æœåŠ¡æ¶æ„</strong></li>
<li>æˆ‘ä»¬è®¾è®¡å¹¶å®ç°äº†<strong>ç”µå½±æœåŠ¡</strong>å’Œ<strong>å½±é™¢ç›®å½•æœåŠ¡</strong></li>
<li>æˆ‘ä»¬å®ç°äº†è¿™äº›æœåŠ¡çš„ API æ¥å£ï¼Œå¹¶å¯¹è¿™äº›æ¥å£åšäº†<strong>å•å…ƒæµ‹è¯•</strong></li>
<li>æˆ‘ä»¬å¯¹è¿è¡Œäº<strong>Docker</strong>ä¸­çš„<strong>æœåŠ¡</strong>è¿›è¡Œäº†é›†æˆæµ‹è¯•</li>
<li>æˆ‘ä»¬è®¨è®ºäº†<strong>å¾®æœåŠ¡å®‰å…¨</strong>å¹¶ä½¿å…¶é€‚é…äº† <strong>HTTP/2 åè®®</strong></li>
<li>æˆ‘ä»¬å¯¹<strong>å½±é™¢ç›®å½•æœåŠ¡</strong>è¿›è¡Œäº†<strong>å‹åŠ›æµ‹è¯•</strong></li>
</ul>
<a id="more"></a>
<p>å¦‚æœä½ æ²¡æœ‰é˜…è¯»ä¹‹å‰çš„ç« èŠ‚ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½ä¼šé”™ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ ğŸ¤˜ğŸ½ï¼Œä¸‹é¢æˆ‘åˆ—å‡ºå‰ä¸¤ç¯‡çš„é“¾æ¥ï¼Œæ–¹ä¾¿ä½ æœ‰å…´è¶£çš„è¯å¯ä»¥çœ‹ä¸€ä¸‹ğŸ‘€ã€‚</p>
<ul>
<li><a href="https://log.zvz.im/2017/05/24/nodejs-cinema-microservice-part1/">ç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡å¹¶éƒ¨ç½²åˆ° docker ä¸Š â€” Part 1</a></li>
<li><a href="https://log.zvz.im/2017/07/17/nodejs-cinema-microservice-part2/">ç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡å¹¶éƒ¨ç½²åˆ° docker ä¸Š â€” Part 2</a></li>
</ul>
<p>åœ¨ä¹‹å‰çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ä»¥ä¸‹æ¶æ„å›¾ä¸­çš„ä¸Šå±‚éƒ¨åˆ†ï¼Œæ¥ç€ä»æœ¬ç« èµ·ï¼Œæˆ‘ä»¬è¦å¼€å§‹å›¾ä¸­ä¸‹å±‚éƒ¨åˆ†çš„å¼€å‘äº†ã€‚</p>
<p><img src="https://img.zvz.im/imgs/2019/06/5201f3beb0ad3a8e.png" alt=""></p>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„ç»ˆç«¯ç”¨æˆ·å·²ç»èƒ½å¤Ÿåœ¨å½±é™¢çœ‹åˆ°ç”µå½±é¦–æ˜ ä¿¡æ¯ï¼Œé€‰æ‹©å½±é™¢å¹¶ä¸‹å•ä¹°ç¥¨ã€‚æœ¬ç« æˆ‘ä»¬ä¼šç»§ç»­æ„å»º<strong>å½±é™¢æ¶æ„</strong>ï¼Œå¹¶æ¢ç´¢<strong>è®¢ç¥¨æœåŠ¡</strong>å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè·Ÿæˆ‘ä¸€èµ·å­¦ç‚¹æœ‰è¶£çš„ä¸œè¥¿å§ã€‚</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨åˆ°ä»¥ä¸‹æŠ€æœ¯ï¼š</p>
<ul>
<li>NodeJS version 7.5.0</li>
<li>MongoDB 3.4.1</li>
<li>Docker for Mac 1.13</li>
</ul>
<p>è¦è·Ÿä¸Šæœ¬æ–‡çš„è¿›åº¦æœ‰ä»¥ä¸‹è¦æ±‚ï¼š</p>
<ul>
<li>å·²ç»å®Œæˆ<a href="https://log.zvz.im/2017/05/24/nodejs-cinema-microservice-part1/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­çš„ä¾‹å­ä»£ç </li>
</ul>
<p>å¦‚æœä½ è¿˜æ²¡æœ‰å®Œæˆè¿™äº›ä»£ç ï¼Œæˆ‘å·²ç»å°†ä»£ç ä¼ åˆ°äº† github ä¸Šï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨<a href="https://github.com/Crizstian/cinema-microservice/tree/step-1" target="_blank" rel="external">ä»£ç åº“</a>åˆ†æ”¯ <strong>step-2</strong>ã€‚</p>
<h2 id="NodeJS-ä¸­çš„ä¾èµ–æ³¨å…¥"><a href="#NodeJS-ä¸­çš„ä¾èµ–æ³¨å…¥" class="headerlink" title="# NodeJS ä¸­çš„ä¾èµ–æ³¨å…¥"></a># NodeJS ä¸­çš„ä¾èµ–æ³¨å…¥</h2><p>è‡³ä»Šä¸ºæ­¢æˆ‘ä»¬å·²ç»æ„å»ºäº†ä¸¤å¥—å¾®æœåŠ¡çš„ API æ¥å£ï¼Œä¸è¿‡éƒ½æ²¡æœ‰é‡åˆ°å¤ªå¤šçš„é…ç½®å’Œå¼€å‘å·¥ä½œï¼Œè¿™æ˜¯ç”±è¿™äº›å¾®æœåŠ¡è‡ªèº«çš„ç‰¹æ€§å’Œç®€å•æ€§å†³å®šçš„ã€‚ä¸è¿‡è¿™ä¸€æ¬¡ï¼Œåœ¨<strong>è®¢ç¥¨æœåŠ¡</strong>ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æ›´å¤šä¸å…¶å®ƒæœåŠ¡ä¹‹é—´çš„äº¤äº’ï¼Œå› ä¸ºè¿™ä¸ªæœåŠ¡çš„å®ç°ä¾èµ–é¡¹æ›´å¤šï¼Œä¸ºäº†é˜²æ­¢å†™å‡ºä¸€å›¢ä¹±éº»ä¼¼çš„ä»£ç ï¼Œä½œä¸ºå¥½çš„å¼€å‘è€…ï¼Œæˆ‘ä»¬éœ€è¦éµå¾ªæŸç§è®¾è®¡æ¨¡å¼ï¼Œä¸ºæ­¤æˆ‘ä»¬å°†ä¼šæ¢ç©¶ä»€ä¹ˆæ˜¯<strong>â€œä¾èµ–æ³¨å…¥â€</strong>ã€‚</p>
<p>æƒ³è¦è¾¾æˆè‰¯å¥½çš„è®¾è®¡æ¨¡å¼ï¼Œæˆ‘ä»¬å¿…é¡»å¾ˆå¥½åœ°ç†è§£å¹¶åº”ç”¨ <strong>S.O.L.I.D åŸåˆ™</strong>ï¼Œæˆ‘ä¹‹å‰å†™è¿‡ä¸€ç¯‡ä¸ä¹‹ç›¸å…³çš„ javascript çš„æ–‡ç« ï¼Œæœ‰ç©ºä½ å¯ä»¥çœ‹ä¸€ä¸‹ğŸ¤“ï¼Œä¸»è¦è®²è¿°äº†è¿™äº›åŸåˆ™æ˜¯ä»€ä¹ˆå¹¶ä¸”æˆ‘ä»¬å¯ä»¥ä»ä¸­è·å¾—å“ªäº›å¥½å¤„ã€‚</p>
<p><a href="https://medium.com/@cramirez92/s-o-l-i-d-the-first-5-priciples-of-object-oriented-design-with-javascript-790f6ac9b9fa" target="_blank" rel="external">S.O.L.I.D The first 5 principles of Ojbect Oriented Design with Javascritp</a></p>
<p>ä¸ºä»€ä¹ˆä¾èµ–æ³¨å…¥å¦‚æ­¤é‡è¦ï¼Ÿå› ä¸ºå®ƒèƒ½ç»™æˆ‘ä»¬å¸¦æ¥ä»¥ä¸‹å¼€å‘æ¨¡å¼ä¸­çš„ä¸‰å¤§å¥½å¤„ï¼š</p>
<ul>
<li><strong>è§£è€¦</strong>ï¼šä¾èµ–æ³¨å…¥å¯å‡å°‘æ¨¡å—ä¹‹é—´çš„è€¦åˆæ€§ï¼Œä½¿å…¶æ›´æ˜“äºç»´æŠ¤ã€‚</li>
<li><strong>å•å…ƒæµ‹è¯•</strong>ï¼šä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œå¯ä½¿å¯¹äºæ¯ä¸ªæ¨¡å—çš„å•å…ƒæµ‹è¯•åšå¾—æ›´å¥½ï¼Œä»£ç çš„ bug ä¹Ÿä¼šè¾ƒå°‘ã€‚</li>
<li><strong>å¿«é€Ÿå¼€å‘</strong>ï¼šåˆ©ç”¨ä¾èµ–æ³¨å…¥ï¼Œåœ¨å®šä¹‰äº†æ¥å£ä¹‹åï¼Œå¯ä»¥æ›´åŠ å®¹æ˜“åœ°è¿›è¡Œåˆ†å·¥åˆä½œè€Œä¸ä¼šäº§ç”Ÿå†²çªã€‚</li>
</ul>
<p>è‡³ä»Šä¸ºæ­¤å¼€å‘çš„å¾®æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬æ›¾åœ¨ <code>index.js</code> æ–‡ä»¶ä¸­ä½¿ç”¨åˆ°äº†<strong>ä¾èµ–æ³¨å…¥</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// more code</span></div><div class="line"></div><div class="line">mediator.on(<span class="string">'db.ready'</span>, (db) =&gt; &#123;</div><div class="line">  <span class="keyword">let</span> rep</div><div class="line">  <span class="comment">// here we are making DI to the repository</span></div><div class="line">  <span class="comment">// we are injecting the database object and the ObjectID object</span></div><div class="line">  repository.connect(&#123;</div><div class="line">    db, </div><div class="line">    <span class="attr">ObjectID</span>: config.ObjectID</div><div class="line">  &#125;)</div><div class="line">  .then(<span class="function"><span class="params">repo</span> =&gt;</span> &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'Connected. Starting Server'</span>)</div><div class="line">      rep = repo</div><div class="line">      <span class="comment">// here we are also making DI to the server</span></div><div class="line">      <span class="comment">// we are injecting serverSettings and the repo object</span></div><div class="line">      <span class="keyword">return</span> server.start(&#123;</div><div class="line">        <span class="attr">port</span>: config.serverSettings.port,</div><div class="line">        <span class="attr">ssl</span>: config.serverSettings.ssl,</div><div class="line">        repo</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">    .then(<span class="function"><span class="params">app</span> =&gt;</span> &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">`Server started succesfully, running on port: <span class="subst">$&#123;config.serverSettings.port&#125;</span>.`</span>)</div><div class="line">      app.on(<span class="string">'close'</span>, () =&gt; &#123;</div><div class="line">        rep.disconnect()</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// more code</span></div></pre></td></tr></table></figure>
<p>åœ¨ <code>index.js</code> æ–‡ä»¶ä¸­æˆ‘ä»¬ä½¿ç”¨äº†æ‰‹åŠ¨çš„ä¾èµ–æ³¨å…¥ï¼Œå› ä¸ºæ²¡æœ‰å¿…è¦åšå¾—æ›´å¤šã€‚ä¸è¿‡åœ¨<strong>è®¢ç¥¨æœåŠ¡</strong>ä¸­ï¼Œæˆ‘ä»¬å°†éœ€è¦ä¸€ç§æ›´å¥½åœ°ä¾èµ–æ³¨å…¥æ–¹å¼ï¼Œä¸ºäº†å˜æ¸…ä¸ªä¸­ç¼˜ç”±ï¼Œåœ¨å¼€å§‹æ„å»º API æ¥å£ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å…ˆå¼„æ¸…æ¥š<strong>è®¢ç¥¨æœåŠ¡</strong>éœ€è¦å®Œæˆå“ªäº›ä»»åŠ¡ã€‚</p>
<ul>
<li>è®¢ç¥¨æœåŠ¡éœ€è¦ä¸€ä¸ªè®¢ç¥¨å¯¹è±¡å’Œä¸€ä¸ªç”¨æˆ·å¯¹è±¡ï¼Œè€Œä¸”åœ¨è¿›è¡Œè®¢ç¥¨åŠ¨ä½œæ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆè¦éªŒè¯è¿™äº›å¯¹è±¡çš„æœ‰æ•ˆæ€§ã€‚</li>
<li>éªŒè¯æœ‰æ•ˆæ€§ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­æµç¨‹ï¼Œå¼€å§‹ä¹°ç¥¨äº†ã€‚</li>
<li>è®¢ç¥¨æœåŠ¡éœ€è¦ç”¨æˆ·çš„ä¿¡ç”¨å¡ä¿¡æ¯ï¼Œé€šè¿‡<strong>æ”¯ä»˜æœåŠ¡</strong>ï¼Œæ¥å®Œæˆè´­ç¥¨åŠ¨ä½œã€‚</li>
<li>æ‰£æ¬¾æˆåŠŸåï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡<strong>é€šçŸ¥æœåŠ¡</strong>å‘é€é€šçŸ¥ã€‚</li>
<li>æˆ‘ä»¬è¿˜éœ€è¦ä¸ºç”¨æˆ·ç”Ÿæˆç”µå½±ç¥¨ï¼Œå¹¶å°†ç”µå½±ç¥¨å’Œè®¢å•å·ä¿¡æ¯å‘é€ç»™ç”¨æˆ·ã€‚</li>
</ul>
<p>æ‰€ä»¥è¿™æ¬¡æˆ‘ä»¬çš„å¼€å‘ä»»åŠ¡å˜å¾—ç›¸å¯¹é‡äº†ä¸€äº›ï¼Œç›¸åº”åœ°ä»£ç ä¹Ÿä¼šå˜å¤šï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå•ä¸€ä¾èµ–æ³¨å…¥æ¥æºçš„åŸå› ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦åšæ›´å¤šçš„åŠŸèƒ½å¼€å‘ã€‚</p>
<h2 id="æ„å»ºå¾®æœåŠ¡"><a href="#æ„å»ºå¾®æœåŠ¡" class="headerlink" title="# æ„å»ºå¾®æœåŠ¡"></a># æ„å»ºå¾®æœåŠ¡</h2><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹<strong>è®¢ç¥¨æœåŠ¡</strong>çš„ <strong>RAML</strong> æ–‡ä»¶ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#%RAML 1.0</span></div><div class="line"><span class="attr">title:</span> <span class="string">Booking</span> <span class="string">Service</span></div><div class="line"><span class="attr">version:</span> <span class="string">v1</span></div><div class="line"><span class="attr">baseUri:</span> <span class="string">/</span></div><div class="line"></div><div class="line"><span class="attr">types:</span></div><div class="line"><span class="attr">  Booking:</span></div><div class="line"><span class="attr">    properties:</span></div><div class="line"><span class="attr">      city:</span> <span class="string">string</span></div><div class="line"><span class="attr">      cinema:</span> <span class="string">string</span></div><div class="line"><span class="attr">      movie:</span> <span class="string">string</span></div><div class="line"><span class="attr">      schedule:</span> <span class="string">datetime</span></div><div class="line"><span class="attr">      cinemaRoom:</span> <span class="string">string</span></div><div class="line"><span class="attr">      seats:</span> <span class="string">array</span></div><div class="line"><span class="attr">      totalAmount:</span> <span class="string">number</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="attr">  User:</span></div><div class="line"><span class="attr">    properties:</span></div><div class="line"><span class="attr">      name:</span> <span class="string">string</span></div><div class="line"><span class="attr">      lastname:</span> <span class="string">string</span></div><div class="line"><span class="attr">      email:</span> <span class="string">string</span></div><div class="line"><span class="attr">      creditcard:</span> <span class="string">object</span></div><div class="line">      <span class="string">phoneNumber?:</span> <span class="string">string</span></div><div class="line">      <span class="string">membership?:</span> <span class="string">number</span></div><div class="line"></div><div class="line"><span class="attr">  Ticket:</span></div><div class="line"><span class="attr">    properties:</span></div><div class="line"><span class="attr">      cinema:</span> <span class="string">string</span></div><div class="line"><span class="attr">      schedule:</span> <span class="string">string</span></div><div class="line"><span class="attr">      movie:</span> <span class="string">string</span></div><div class="line"><span class="attr">      seat:</span> <span class="string">string</span></div><div class="line"><span class="attr">      cinemaRoom:</span> <span class="string">string</span></div><div class="line"><span class="attr">      orderId:</span> <span class="string">string</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="attr">resourceTypes:</span></div><div class="line"><span class="attr">  GET:</span></div><div class="line"><span class="attr">    get:</span></div><div class="line"><span class="attr">      responses:</span></div><div class="line">        <span class="number">200</span><span class="string">:</span></div><div class="line"><span class="attr">          body:</span></div><div class="line">            <span class="string">application/json:</span></div><div class="line"><span class="attr">              type:</span> <span class="string">&lt;&lt;item&gt;&gt;</span></div><div class="line"></div><div class="line"><span class="attr">  POST:</span></div><div class="line"><span class="attr">    post:</span></div><div class="line"><span class="attr">      body:</span></div><div class="line">        <span class="string">application/json:</span></div><div class="line"><span class="attr">          type:</span> <span class="string">&lt;&lt;item&gt;&gt;</span></div><div class="line"><span class="attr">          type:</span> <span class="string">&lt;&lt;item2&gt;&gt;</span></div><div class="line"><span class="attr">      responses:</span></div><div class="line">        <span class="number">201</span><span class="string">:</span></div><div class="line"><span class="attr">          body:</span></div><div class="line">            <span class="string">application/json:</span></div><div class="line"><span class="attr">              type:</span> <span class="string">&lt;&lt;item3&gt;&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="string">/booking:</span></div><div class="line"><span class="attr">  type:</span>   <span class="string">&#123;</span> <span class="attr">POST:</span> <span class="string">&#123;item</span> <span class="string">:</span> <span class="string">Booking,</span> <span class="string">item2</span> <span class="string">:</span> <span class="string">User,</span> <span class="attr">item3:</span> <span class="string">Ticket&#125;</span> <span class="string">&#125;</span></div><div class="line"><span class="attr">  description:</span> <span class="string">The</span> <span class="string">booking</span> <span class="string">service</span> <span class="string">need</span> <span class="string">a</span> <span class="string">Booking</span> <span class="string">object</span> <span class="string">that</span> <span class="string">contains</span> <span class="string">all</span></div><div class="line">    <span class="string">the</span> <span class="string">needed</span> <span class="string">information</span> <span class="string">to</span> <span class="string">make</span> <span class="string">a</span> <span class="string">purchase</span> <span class="string">of</span> <span class="string">cinema</span> <span class="string">tickets.</span> <span class="string">Needs</span> <span class="string">a</span> <span class="string">user</span> <span class="string">information</span> <span class="string">to</span> <span class="string">make</span> <span class="string">the</span> <span class="string">booking</span> <span class="string">succesfully.</span> <span class="string">And</span> <span class="string">returns</span> <span class="string">a</span> <span class="string">ticket</span> <span class="string">object.</span></div><div class="line"></div><div class="line">  <span class="string">/verify/&#123;orderId&#125;:</span></div><div class="line"><span class="attr">    type:</span>  <span class="string">&#123;</span> <span class="attr">GET:</span> <span class="string">&#123;item</span> <span class="string">:</span> <span class="string">Ticket&#125;</span> <span class="string">&#125;</span></div><div class="line"><span class="attr">    description:</span> <span class="string">This</span> <span class="string">route</span> <span class="string">is</span> <span class="string">for</span> <span class="string">verify</span> <span class="string">orders,</span> <span class="string">and</span> <span class="string">would</span> <span class="string">return</span> <span class="string">all</span> <span class="string">the</span> <span class="string">details</span> <span class="string">of</span> <span class="string">a</span> <span class="string">specific</span> <span class="string">purchased</span> <span class="string">by</span> <span class="string">orderid.</span></div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å®šä¹‰äº†ä¸‰ä¸ªæ¨¡å‹å¯¹è±¡ï¼Œ<strong>Booking</strong> ã€<strong>User</strong> ä»¥åŠ <strong>Ticket</strong> ã€‚ç”±äºè¿™æ˜¯ç³»åˆ—æ–‡ç« ä¸­ç¬¬ä¸€æ¬¡ä½¿ç”¨åˆ° <strong>POST</strong> è¯·æ±‚ï¼Œå› æ­¤è¿˜æœ‰ä¸€é¡¹ NodeJS çš„<strong>æœ€ä½³å®è·µ</strong>æˆ‘ä»¬è¿˜æ²¡æœ‰ä½¿ç”¨è¿‡ï¼Œé‚£å°±æ˜¯<strong>æ•°æ®éªŒè¯</strong>ã€‚åœ¨<a href="https://medium.com/software-engineering/beautiful-node-apis-eaf0b636cbe#.t8kdvpkcv" target="_blank" rel="external">â€œBuild beautiful node APIâ€™sâ€œ</a> è¿™ç¯‡æ–‡ç« ä¸­æœ‰ä¸€å¥å¾ˆå¥½çš„è¡¨è¿°ï¼š</p>
<blockquote>
<p>ä¸€å®šï¼Œä¸€å®šï¼Œä¸€å®šè¦éªŒè¯è¾“å…¥ï¼ˆä»¥åŠè¾“å‡ºï¼‰çš„æ•°æ®ã€‚æœ‰ joi ä»¥åŠ express-validator ç­‰æ¨¡å—å¯ä»¥å¸®åŠ©ä½ ä¼˜é›…åœ°å®Œæˆæ•°æ®å‡€åŒ–å·¥ä½œã€‚â€” Azat Mardan</p>
</blockquote>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹å¼€å‘<strong>è®¢ç¥¨æœåŠ¡</strong>äº†ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ä¸ä¸Šä¸€ç« ç›¸åŒçš„é¡¹ç›®ç»“æ„ï¼Œä¸è¿‡ä¼šç¨å¾®åšä¸€ç‚¹ç‚¹æ”¹åŠ¨ã€‚è®©æˆ‘ä»¬ä¸å†çº¸ä¸Šè°ˆå…µï¼Œæ’¸èµ·è¢–å­å¼€å§‹ç¼–ç ï¼ ğŸ‘©ğŸ»â€ğŸ’»ğŸ‘¨ğŸ»â€ğŸ’»ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬åœ¨ <code>/src</code> ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª <code>models</code> ç›®å½•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">booking-service/src $ mkdir models</div><div class="line"></div><div class="line"># Now let&apos;s move to the folder and create some files</div><div class="line"></div><div class="line">booking-service/src/models $ touch user.js booking.js ticket.js</div><div class="line"></div><div class="line"># Now is moment to install a new npm package for data validation</div><div class="line"></div><div class="line">npm i -S joi --silent</div></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬å¼€å§‹ç¼–å†™æ•°æ®ç»“æ„éªŒè¯å¯¹è±¡äº†ï¼Œ<strong>MonogDB</strong>ä¹Ÿæœ‰å†…ç½®çš„éªŒè¯å¯¹è±¡ï¼Œä¸è¿‡è¿™é‡Œéœ€è¦éªŒè¯çš„æ˜¯æ•°æ®å¯¹è±¡çš„å®Œæ•´æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ joiï¼Œè€Œä¸” joi ä¹Ÿå…è®¸æˆ‘ä»¬åŒæ—¶è¿›è¡Œæ•°æ®éªŒè¯ï¼Œæˆ‘ä»¬å°±ç”± <strong>booking.model.js</strong> å¼€å§‹ï¼Œç„¶åæ˜¯ <strong>ticket.model.js</strong>ï¼Œ æœ€åæ˜¯ <strong>user.model.js</strong>ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> bookingSchema = <span class="function">(<span class="params">joi</span>) =&gt;</span> (&#123;</div><div class="line">  <span class="attr">bookingSchema</span>: joi.object().keys(&#123;</div><div class="line">    <span class="attr">city</span>: joi.string(),</div><div class="line">    <span class="attr">schedule</span>: joi.date().min(<span class="string">'now'</span>),</div><div class="line">    <span class="attr">movie</span>: joi.string(),</div><div class="line">    <span class="attr">cinemaRoom</span>: joi.number(),</div><div class="line">    <span class="attr">seats</span>: joi.array().items(joi.string()).single(),</div><div class="line">    <span class="attr">totalAmount</span>: joi.number()</div><div class="line">  &#125;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = bookingSchema</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> ticketSchema = <span class="function">(<span class="params">joi</span>) =&gt;</span> (&#123;</div><div class="line">  <span class="attr">ticketSchema</span>: joi.object().keys(&#123;</div><div class="line">    <span class="attr">cinema</span>: joi.string(),</div><div class="line">    <span class="attr">schedule</span>: joi.date().min(<span class="string">'now'</span>),</div><div class="line">    <span class="attr">movie</span>: joi.string(),</div><div class="line">    <span class="attr">seat</span>: joi.array().items(joi.string()).single(),</div><div class="line">    <span class="attr">cinemaRoom</span>: joi.number(),</div><div class="line">    <span class="attr">orderId</span>: joi.number()</div><div class="line">  &#125;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = ticketSchema</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> userSchema = <span class="function">(<span class="params">joi</span>) =&gt;</span> (&#123;</div><div class="line">  <span class="attr">userSchema</span>: joi.object().keys(&#123;</div><div class="line">    <span class="attr">name</span>: joi.string().regex(<span class="regexp">/^[a-bA-B]+/</span>).required(),</div><div class="line">    <span class="attr">lastName</span>: joi.string().regex(<span class="regexp">/^[a-bA-B]+/</span>).required(),</div><div class="line">    <span class="attr">email</span>: joi.string().email().required(),</div><div class="line">    <span class="attr">phoneNumber</span>: joi.string().regex(<span class="regexp">/^(\+0?1\s)?\(?\d&#123;3&#125;\)?[\s.-]\d&#123;3&#125;[\s.-]\d&#123;4&#125;$/</span>),</div><div class="line">    <span class="attr">creditCard</span>: joi.string().creditCard().required(),</div><div class="line">    <span class="attr">membership</span>: joi.number().creditCard()</div><div class="line">  &#125;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = userSchema</div></pre></td></tr></table></figure>
<p>å¦‚æœä½ ä¸æ˜¯å¤ªäº†è§£ <code>joi</code> ï¼Œä½ å¯ä»¥å» github ä¸Šå­¦ä¹ ä¸€ä¸‹å®ƒçš„æ–‡æ¡£ï¼š<a href="https://github.com/hapijs/joi/blob/v10.2.0/API.md" target="_blank" rel="external">æ–‡æ¡£é“¾æ¥</a></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç¼–å†™æ¨¡å—çš„ <code>index.js</code> æ–‡ä»¶ï¼Œä½¿è¿™äº›æ ¡éªŒæ–¹æ³•æš´éœ²å‡ºæ¥ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> joi = <span class="built_in">require</span>(<span class="string">'joi'</span>)</div><div class="line"><span class="keyword">const</span> user = <span class="built_in">require</span>(<span class="string">'./user.model'</span>)(joi)</div><div class="line"><span class="keyword">const</span> booking = <span class="built_in">require</span>(<span class="string">'./booking.model'</span>)(joi)</div><div class="line"><span class="keyword">const</span> ticket = <span class="built_in">require</span>(<span class="string">'./ticket.model'</span>)(joi)</div><div class="line"></div><div class="line"><span class="keyword">const</span> schemas = <span class="built_in">Object</span>.create(&#123;user, booking, ticket&#125;)</div><div class="line"></div><div class="line"><span class="keyword">const</span> schemaValidator = <span class="function">(<span class="params">object, type</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">if</span> (!object) &#123;</div><div class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'object to validate not provided'</span>))</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!type) &#123;</div><div class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'schema type to validate not provided'</span>))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> &#123;error, value&#125; = joi.validate(object, schemas[type])</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (error) &#123;</div><div class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`invalid <span class="subst">$&#123;type&#125;</span> data, err: <span class="subst">$&#123;error&#125;</span>`</span>))</div><div class="line">    &#125;</div><div class="line">    resolve(value)</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="built_in">Object</span>.create(&#123;<span class="attr">validate</span>: schemaValidator&#125;)</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ‰€å†™çš„è¿™äº›ä»£ç åº”ç”¨äº†<strong>SOLID åŸåˆ™</strong>ä¸­çš„<strong>å•ä¸€è´£ä»»åŸåˆ™</strong>ï¼Œæ¯ä¸ªæ¨¡å‹éƒ½æœ‰è‡ªå·±çš„æ ¡éªŒæ–¹æ³•ï¼Œè¿˜åº”ç”¨äº†<strong>å¼€æ”¾å°é—­åŸåˆ™</strong>ï¼Œæ¯ä¸ªç»“æ„æ ¡éªŒå‡½æ•°éƒ½å¯ä»¥å¯¹ä»»æ„å¤šçš„æ¨¡å‹å¯¹è±¡è¿›è¡Œæ ¡éªŒï¼Œæ¥ä¸‹æ¥çœ‹çœ‹å¦‚ä½•ä¸ºè¿™äº›æ¨¡å‹ç¼–å†™æµ‹è¯•ä»£ç ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* eslint-env mocha */</span></div><div class="line"><span class="keyword">const</span> test = <span class="built_in">require</span>(<span class="string">'assert'</span>)</div><div class="line"><span class="keyword">const</span> &#123;validate&#125; = <span class="built_in">require</span>(<span class="string">'./'</span>)</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.getPrototypeOf(validate))</div><div class="line"></div><div class="line">describe(<span class="string">'Schemas Validation'</span>, () =&gt; &#123;</div><div class="line">  it(<span class="string">'can validate a booking object'</span>, (done) =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>()</div><div class="line">    now.setDate(now.getDate() + <span class="number">1</span>)</div><div class="line"></div><div class="line">    <span class="keyword">const</span> testBooking = &#123;</div><div class="line">      <span class="attr">city</span>: <span class="string">'Morelia'</span>,</div><div class="line">      <span class="attr">cinema</span>: <span class="string">'Plaza Morelia'</span>,</div><div class="line">      <span class="attr">movie</span>: <span class="string">'Assasins Creed'</span>,</div><div class="line">      <span class="attr">schedule</span>: now,</div><div class="line">      <span class="attr">cinemaRoom</span>: <span class="number">7</span>,</div><div class="line">      <span class="attr">seats</span>: [<span class="string">'45'</span>],</div><div class="line">      <span class="attr">totalAmount</span>: <span class="number">71</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    validate(testBooking, <span class="string">'booking'</span>)</div><div class="line">      .then(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'validated'</span>)</div><div class="line">        <span class="built_in">console</span>.log(value)</div><div class="line">        done()</div><div class="line">      &#125;)</div><div class="line">      .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(err)</div><div class="line">        done()</div><div class="line">      &#125;)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  it(<span class="string">'can validate a user object'</span>, (done) =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> testUser = &#123;</div><div class="line">      <span class="attr">name</span>: <span class="string">'Cristian'</span>,</div><div class="line">      <span class="attr">lastName</span>: <span class="string">'Ramirez'</span>,</div><div class="line">      <span class="attr">email</span>: <span class="string">'cristiano@nupp.com'</span>,</div><div class="line">      <span class="attr">creditCard</span>: <span class="string">'1111222233334444'</span>,</div><div class="line">      <span class="attr">membership</span>: <span class="string">'7777888899990000'</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    validate(testUser, <span class="string">'user'</span>)</div><div class="line">      .then(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'validated'</span>)</div><div class="line">        <span class="built_in">console</span>.log(value)</div><div class="line">        done()</div><div class="line">      &#125;)</div><div class="line">      .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(err)</div><div class="line">        done()</div><div class="line">      &#125;)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  it(<span class="string">'can validate a ticket object'</span>, (done) =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> testTicket = &#123;</div><div class="line">      <span class="attr">cinema</span>: <span class="string">'Plaza Morelia'</span>,</div><div class="line">      <span class="attr">schedule</span>: <span class="keyword">new</span> <span class="built_in">Date</span>(),</div><div class="line">      <span class="attr">movie</span>: <span class="string">'Assasins Creed'</span>,</div><div class="line">      <span class="attr">seats</span>: [<span class="string">'35'</span>],</div><div class="line">      <span class="attr">cinemaRoom</span>: <span class="number">1</span>,</div><div class="line">      <span class="attr">orderId</span>: <span class="string">'34jh1231ll'</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    validate(testTicket, <span class="string">'ticket'</span>)</div><div class="line">      .then(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'validated'</span>)</div><div class="line">        <span class="built_in">console</span>.log(value)</div><div class="line">        done()</div><div class="line">      &#125;)</div><div class="line">      .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(err)</div><div class="line">        done()</div><div class="line">      &#125;)</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>ç„¶åï¼Œæˆ‘ä»¬è¦çœ‹çš„ä»£ç æ–‡ä»¶æ˜¯ <code>api/booking.js</code> ï¼Œæˆ‘ä»¬å°†ä¼šé‡åˆ°æ›´å¤šçš„éº»çƒ¦äº†ï¼Œ<strong>Â¿ ä¸ºä»€ä¹ˆå‘¢ ?</strong>ï¼Œå› ä¸ºè¿™é‡Œæˆ‘ä»¬å°†ä¼šä¸<strong>ä¸¤ä¸ªå¤–éƒ¨æœåŠ¡</strong>è¿›è¡Œäº¤äº’ï¼š<strong>æ”¯ä»˜æœåŠ¡</strong>ä»¥åŠ<strong>é€šçŸ¥æœåŠ¡</strong>ï¼Œè€Œä¸”è¿™ç±»äº¤äº’ä¼šå¼•å‘æˆ‘ä»¬é‡æ–°æ€è€ƒå¾®æœåŠ¡çš„æ¶æ„ï¼Œå¹¶ä¼šç‰µæ‰¯åˆ°è¢«ç§°ä½œ<strong>æ—¶é—´é©±åŠ¨æ•°æ®ç®¡ç†</strong>ä»¥åŠ <strong>CQRS</strong> çš„è¯¾é¢˜ï¼Œä¸è¿‡æˆ‘ä»¬å°†æŠŠè¿™äº›è¯¾é¢˜ç•™åˆ°ä¹‹åçš„ç« èŠ‚å†è¿›è¡Œè®¨è®ºï¼Œé¿å…æœ¬ç« å˜å¾—è¿‡äºå¤æ‚å†—é•¿ã€‚æ‰€ä»¥ï¼Œæœ¬ç« æˆ‘ä»¬å…ˆä¸è¿™äº›æœåŠ¡è¿›è¡Œç®€å•åœ°äº¤äº’ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span></div><div class="line"><span class="keyword">const</span> status = <span class="built_in">require</span>(<span class="string">'http-status'</span>)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">&#123;repo&#125;, app</span>) =&gt;</span> &#123;</div><div class="line">  app.post(<span class="string">'/booking'</span>, (req, res, next) =&gt; &#123;</div><div class="line">    </div><div class="line">    <span class="comment">// we grab the dependencies need it for this route</span></div><div class="line">    <span class="keyword">const</span> validate = req.container.resolve(<span class="string">'validate'</span>)</div><div class="line">    <span class="keyword">const</span> paymentService = req.container.resolve(<span class="string">'paymentService'</span>)</div><div class="line">    <span class="keyword">const</span> notificationService = req.container.resolve(<span class="string">'notificationService'</span>)</div><div class="line"></div><div class="line">    <span class="built_in">Promise</span>.all([</div><div class="line">      validate(req.body.user, <span class="string">'user'</span>),</div><div class="line">      validate(req.body.booking, <span class="string">'booking'</span>)</div><div class="line">    ])</div><div class="line">    .then(<span class="function">(<span class="params">[user, booking]</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> payment = &#123;</div><div class="line">        <span class="attr">userName</span>: user.name + <span class="string">' '</span> + user.lastName,</div><div class="line">        <span class="attr">currency</span>: <span class="string">'mxn'</span>,</div><div class="line">        <span class="attr">number</span>: user.creditCard.number,</div><div class="line">        <span class="attr">cvc</span>: user.creditCard.cvc,</div><div class="line">        <span class="attr">exp_month</span>: user.creditCard.exp_month,</div><div class="line">        <span class="attr">exp_year</span>: user.creditCard.exp_year,</div><div class="line">        <span class="attr">amount</span>: booking.amount,</div><div class="line">        <span class="attr">description</span>: <span class="string">`</span></div><div class="line">          Tickect(s) for movie <span class="subst">$&#123;booking.movie&#125;</span>,</div><div class="line">          with seat(s) <span class="subst">$&#123;booking.seats.toString()&#125;</span></div><div class="line">          at time <span class="subst">$&#123;booking.schedule&#125;</span>`</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.all([</div><div class="line">        <span class="comment">// we call the payment service</span></div><div class="line">        paymentService(payment),</div><div class="line">        <span class="built_in">Promise</span>.resolve(user),</div><div class="line">        <span class="built_in">Promise</span>.resolve(booking)</div><div class="line">      ])</div><div class="line">    &#125;)</div><div class="line">    .then(<span class="function">(<span class="params">[paid, user, booking]</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.all([</div><div class="line">        repo.makeBooking(user, booking),</div><div class="line">        repo.generateTicket(paid, booking)</div><div class="line">      ])</div><div class="line">    &#125;)</div><div class="line">    .then(<span class="function">(<span class="params">[booking, ticket]</span>) =&gt;</span> &#123;</div><div class="line">      <span class="comment">// we call the notification service</span></div><div class="line">      notificationService(&#123;booking, ticket&#125;)</div><div class="line">      res.status(status.OK).json(ticket)</div><div class="line">    &#125;)</div><div class="line">    .catch(next)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  app.get(<span class="string">'/booking/verify/:orderId'</span>, (req, res, next) =&gt; &#123;</div><div class="line">    repo.getOrderById(req.params.orderId)</div><div class="line">      .then(<span class="function"><span class="params">order</span> =&gt;</span> &#123;</div><div class="line">        res.status(status.OK).json(order)</div><div class="line">      &#125;)</div><div class="line">      .catch(next)</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨åˆ°äº† expressjs çš„<strong>ä¸­é—´ä»¶</strong>ï¼š<strong>container</strong>ï¼Œå¹¶å°†å…¶ä½œä¸ºæˆ‘ä»¬æ‰€ç”¨åˆ°çš„ä¾èµ–é¡¹çš„å”¯ä¸€çœŸå®æ¥æºã€‚</p>
<p>ä¸è¿‡åŒ…å«è¿™äº›ä¾èµ–é¡¹çš„ <strong>container</strong> æ˜¯ä»ä½•è€Œæ¥å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬ç°åœ¨å¯¹é¡¹ç›®ç»“æ„åšäº†ä¸€ç‚¹è°ƒæ•´ï¼Œä¸»è¦æ˜¯å¯¹ <code>config</code> ç›®å½•çš„è°ƒæ•´ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">. </div><div class="line">|-- config </div><div class="line">|   |-- db </div><div class="line">|   |   |-- index.js </div><div class="line">|   |   |-- mongo.js </div><div class="line">|   |   `-- mongo.spec.js </div><div class="line">|   |-- di </div><div class="line">|   |   |-- di.js </div><div class="line">|   |   `-- index.js </div><div class="line">|   |-- ssl</div><div class="line">|   |   |-- certificates </div><div class="line">|   |   `-- index.js</div><div class="line">|   |-- config.js</div><div class="line">|   |-- index.spec.js </div><div class="line">|   `-- index.js</div></pre></td></tr></table></figure>
<p>åœ¨ <code>config/index.js</code> æ–‡ä»¶åŒ…å«äº†å‡ ä¹æ‰€æœ‰çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬<strong>ä¾èµ–æ³¨å…¥</strong>æœåŠ¡ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> &#123;dbSettings, serverSettings&#125; = <span class="built_in">require</span>(<span class="string">'./config'</span>)</div><div class="line"><span class="keyword">const</span> database = <span class="built_in">require</span>(<span class="string">'./db'</span>)</div><div class="line"><span class="keyword">const</span> &#123;initDI&#125; = <span class="built_in">require</span>(<span class="string">'./di'</span>)</div><div class="line"><span class="keyword">const</span> models = <span class="built_in">require</span>(<span class="string">'../models'</span>)</div><div class="line"><span class="keyword">const</span> services = <span class="built_in">require</span>(<span class="string">'../services'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> init = initDI.bind(<span class="literal">null</span>, &#123;serverSettings, dbSettings, database, models, services&#125;)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="built_in">Object</span>.assign(&#123;&#125;, &#123;init&#125;)</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬çœ‹åˆ°äº›ä¸å¸¸è§çš„ä¸œè¥¿ï¼Œè¿™é‡Œæå‡ºæ¥ç»™å¤§å®¶çœ‹çœ‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">initDI.bind(<span class="literal">null</span>, &#123;serverSettings, dbSettings, database, models, services&#125;)</div></pre></td></tr></table></figure>
<p>è¿™è¡Œä»£ç åˆ°åº•åšäº†ä»€ä¹ˆå‘¢ï¼Ÿä¹‹å‰æˆ‘æåˆ°è¿‡æˆ‘ä»¬è¦é…ç½®<strong>ä¾èµ–æ³¨å…¥</strong>ï¼Œä¸è¿‡è¿™é‡Œæˆ‘ä»¬åšçš„äº‹æƒ…å«ä½œ<strong>æ§åˆ¶åè½¬</strong>ï¼Œçš„ç¡®è¿™ç§è¯´æ³•å¤ªè¿‡äºæŠ€æœ¯åŒ–äº†ï¼Œç”šè‡³æœ‰äº›å¤¸å¼ ï¼Œä¸è¿‡ä¸€æ—¦ä½ ç†è§£äº†ä¹‹åå°±å¾ˆå®¹æ˜“ç†è§£ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬çš„<strong>ä¾èµ–æ³¨å…¥</strong>å‡½æ•°ä¸éœ€è¦çŸ¥é“ä¾èµ–é¡¹æ¥è‡ªå“ªé‡Œï¼Œå®ƒåªè¦æ³¨å†Œè¿™äº›ä¾èµ–é¡¹ï¼Œä½¿å¾—åº”ç”¨èƒ½å¤Ÿä½¿ç”¨å³å¯ï¼Œæˆ‘ä»¬çš„ <code>di.js</code> çœ‹èµ·æ¥å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> &#123; createContainer, asValue, asFunction, asClass &#125; = <span class="built_in">require</span>(<span class="string">'awilix'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">initDI</span> (<span class="params">&#123;serverSettings, dbSettings, database, models, services&#125;, mediator</span>) </span>&#123;</div><div class="line">  mediator.once(<span class="string">'init'</span>, () =&gt; &#123;</div><div class="line">    mediator.on(<span class="string">'db.ready'</span>, (db) =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> container = createContainer()</div><div class="line">      </div><div class="line">      <span class="comment">// loading dependecies in a single source of truth</span></div><div class="line">      container.register(&#123;</div><div class="line">        <span class="attr">database</span>: asValue(db).singleton(),</div><div class="line">        <span class="attr">validate</span>: asValue(models.validate),</div><div class="line">        <span class="attr">booking</span>: asValue(models.booking),</div><div class="line">        <span class="attr">user</span>: asValue(models.booking),</div><div class="line">        <span class="attr">ticket</span>: asValue(models.booking),</div><div class="line">        <span class="attr">ObjectID</span>: asClass(database.ObjectID),</div><div class="line">        <span class="attr">serverSettings</span>: asValue(serverSettings),</div><div class="line">        <span class="attr">paymentService</span>: asValue(services.paymentService),</div><div class="line">        <span class="attr">notificationService</span>: asValue(services.notificationService)</div><div class="line">      &#125;)</div><div class="line">      </div><div class="line">      <span class="comment">// we emit the container to be able to use it in the API</span></div><div class="line">      mediator.emit(<span class="string">'di.ready'</span>, container)</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">    mediator.on(<span class="string">'db.error'</span>, (err) =&gt; &#123;</div><div class="line">      mediator.emit(<span class="string">'di.error'</span>, err)</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">    database.connect(dbSettings, mediator)</div><div class="line"></div><div class="line">    mediator.emit(<span class="string">'boot.ready'</span>)</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports.initDI = initDI</div></pre></td></tr></table></figure>
<p>å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªåä¸º <code>awilix</code> çš„ npm åŒ…ç”¨ä½œä¾èµ–æ³¨å…¥ï¼Œawilix å®ç°äº† nodejs ä¸­çš„ä¾èµ–æ³¨å…¥æœºåˆ¶ï¼ˆæˆ‘ç›®å‰æ­£åœ¨è¯•ç”¨è¿™ä¸ªåº“ï¼Œè¿™é‡Œä½¿ç”¨å®ƒæ˜¯ä¸ºäº†æ˜¯ä¾‹å­çœ‹èµ·æ¥æ›´åŠ æ¸…æ™°ï¼‰ï¼Œè¦å®‰è£…å®ƒéœ€è¦æ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm i -S awilix --silent</div></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬çš„ä¸» <code>index.js</code> æ–‡ä»¶çœ‹èµ·æ¥å°±åƒè¿™æ ·ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span></div><div class="line"><span class="keyword">const</span> &#123;EventEmitter&#125; = <span class="built_in">require</span>(<span class="string">'events'</span>)</div><div class="line"><span class="keyword">const</span> server = <span class="built_in">require</span>(<span class="string">'./server/server'</span>)</div><div class="line"><span class="keyword">const</span> repository = <span class="built_in">require</span>(<span class="string">'./repository/repository'</span>)</div><div class="line"><span class="keyword">const</span> di = <span class="built_in">require</span>(<span class="string">'./config'</span>)</div><div class="line"><span class="keyword">const</span> mediator = <span class="keyword">new</span> EventEmitter()</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'--- Booking Service ---'</span>)</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Connecting to movies repository...'</span>)</div><div class="line"></div><div class="line">process.on(<span class="string">'uncaughtException'</span>, (err) =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.error(<span class="string">'Unhandled Exception'</span>, err)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">process.on(<span class="string">'uncaughtRejection'</span>, (err, promise) =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.error(<span class="string">'Unhandled Rejection'</span>, err)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">mediator.on(<span class="string">'di.ready'</span>, (container) =&gt; &#123;</div><div class="line">  repository.connect(container)</div><div class="line">    .then(<span class="function"><span class="params">repo</span> =&gt;</span> &#123;</div><div class="line">      container.registerFunction(&#123;repo&#125;)</div><div class="line">      <span class="keyword">return</span> server.start(container)</div><div class="line">    &#125;)</div><div class="line">    .then(<span class="function"><span class="params">app</span> =&gt;</span> &#123;</div><div class="line">      app.on(<span class="string">'close'</span>, () =&gt; &#123;</div><div class="line">        container.resolve(<span class="string">'repo'</span>).disconnect()</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">di.init(mediator)</div><div class="line"></div><div class="line">mediator.emit(<span class="string">'init'</span>)</div></pre></td></tr></table></figure>
<p>ç°åœ¨ä½ èƒ½çœ‹åˆ°ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„åŒ…å«æ‰€æœ‰ä¾èµ–é¡¹çš„çœŸå®å”¯ä¸€æ¥æºï¼Œå¯é€šè¿‡ request çš„ container å±æ€§è®¿é—®ï¼Œè‡³äºæˆ‘ä»¬æ€æ ·é€šè¿‡ expressjs çš„<strong>ä¸­é—´ä»¶</strong>è¿›è¡Œè®¾ç½®çš„ï¼Œå¦‚ä¹‹å‰æåˆ°è¿‡çš„ï¼Œå…¶å®åªéœ€è¦å‡ è¡Œä»£ç ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</div><div class="line"><span class="keyword">const</span> morgan = <span class="built_in">require</span>(<span class="string">'morgan'</span>)</div><div class="line"><span class="keyword">const</span> helmet = <span class="built_in">require</span>(<span class="string">'helmet'</span>)</div><div class="line"><span class="keyword">const</span> bodyparser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</div><div class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">'cors'</span>)</div><div class="line"><span class="keyword">const</span> spdy = <span class="built_in">require</span>(<span class="string">'spdy'</span>)</div><div class="line"><span class="keyword">const</span> _api = <span class="built_in">require</span>(<span class="string">'../api/booking'</span>)</div><div class="line"></div><div class="line"><span class="keyword">const</span> start = <span class="function">(<span class="params">container</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    </div><div class="line">    <span class="comment">// here we grab our dependencies needed for the server</span></div><div class="line">    <span class="keyword">const</span> &#123;repo, port, ssl&#125; = container.resolve(<span class="string">'serverSettings'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!repo) &#123;</div><div class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'The server must be started with a connected repository'</span>))</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!port) &#123;</div><div class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'The server must be started with an available port'</span>))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> app = express()</div><div class="line">    app.use(morgan(<span class="string">'dev'</span>))</div><div class="line">    app.use(bodyparser.json())</div><div class="line">    app.use(cors())</div><div class="line">    app.use(helmet())</div><div class="line">    app.use(<span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">if</span> (err) &#123;</div><div class="line">        reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Something went wrong!, err:'</span> + err))</div><div class="line">        res.status(<span class="number">500</span>).send(<span class="string">'Something went wrong!'</span>)</div><div class="line">      &#125;</div><div class="line">      next()</div><div class="line">    &#125;)</div><div class="line">    </div><div class="line">    <span class="comment">// here is where we register the container as middleware</span></div><div class="line">    app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</div><div class="line">      req.container = container.createScope()</div><div class="line">      next()</div><div class="line">    &#125;)</div><div class="line">    </div><div class="line">    <span class="comment">// here we inject the repo to the API, since the repo is need it for all of our functions</span></div><div class="line">    <span class="comment">// and we are using inversion of control to make it available</span></div><div class="line">    <span class="keyword">const</span> api = _api.bind(<span class="literal">null</span>, &#123;<span class="attr">repo</span>: container.resolve(<span class="string">'repo'</span>)&#125;)</div><div class="line">    api(app)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (process.env.NODE === <span class="string">'test'</span>) &#123;</div><div class="line">      <span class="keyword">const</span> server = app.listen(port, () =&gt; resolve(server))</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">const</span> server = spdy.createServer(ssl, app)</div><div class="line">        .listen(port, () =&gt; resolve(server))</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="built_in">Object</span>.assign(&#123;&#125;, &#123;start&#125;)</div></pre></td></tr></table></figure>
<p>åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬åªæ˜¯å°† <strong>container</strong> å¯¹è±¡é™„åŠ åˆ°äº† expressjs çš„ <strong>req å¯¹è±¡</strong>ä¸Šï¼Œè¿™æ · expressjs çš„æ‰€æœ‰è·¯ç”±ä¸Šéƒ½èƒ½è®¿é—®åˆ°å®ƒäº†ã€‚å¦‚æœä½ æƒ³æ›´æ·±å…¥åœ°äº†è§£ expressjs çš„ä¸­é—´ä»¶æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä½ å¯ä»¥ç‚¹å‡»<a href="http://expressjs.com/en/guide/using-middleware.html" target="_blank" rel="external">è¿™ä¸ªé“¾æ¥æŸ¥çœ‹ expressjs çš„æ–‡æ¡£</a>ã€‚</p>
<p>å¸¸è¨€é“å¥½äº‹å¤šç£¨ï¼Œæœ€åè®©æˆ‘ä»¬æ¥çœ‹çœ‹ <code>repository.js</code> æ–‡ä»¶ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="meta"></span></div><div class="line">'use strict'</div><div class="line"><span class="keyword">const</span> repository = <span class="function">(<span class="params">container</span>) =&gt;</span> &#123;</div><div class="line">  <span class="comment">// we get the db object via the container</span></div><div class="line">  <span class="keyword">const</span> &#123;db&#125; = container.resolve(<span class="string">'database'</span>)</div><div class="line"></div><div class="line">  <span class="keyword">const</span> makeBooking = <span class="function">(<span class="params">user, booking</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">      <span class="comment">// payload to be insterted to the booking collection </span></div><div class="line">      <span class="keyword">const</span> payload = &#123;</div><div class="line">        <span class="attr">city</span>: booking.city,</div><div class="line">        <span class="attr">cinema</span>: booking.cinema,</div><div class="line">        <span class="attr">book</span>: &#123;</div><div class="line">          <span class="attr">userType</span>: (user.membership) ? <span class="string">'loyal'</span> : <span class="string">'normal'</span>,</div><div class="line">          <span class="attr">movie</span>: &#123;</div><div class="line">            <span class="attr">title</span>: booking.movie.title,</div><div class="line">            <span class="attr">format</span>: booking.movie.format,</div><div class="line">            <span class="attr">schedule</span>: booking.schedule</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      db.collection(<span class="string">'booking'</span>).insertOne(payload, (err, booked) =&gt; &#123;</div><div class="line">        <span class="keyword">if</span> (err) &#123;</div><div class="line">          reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'An error occuered registring a user booking, err:'</span> + err))</div><div class="line">        &#125;</div><div class="line">        resolve(booked)</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> generateTicket = <span class="function">(<span class="params">paid, booking</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">      <span class="comment">// payload of ticket</span></div><div class="line">      <span class="keyword">const</span> payload = <span class="built_in">Object</span>.assign(&#123;&#125;, &#123;booking, <span class="attr">orderId</span>: paid._id&#125;)</div><div class="line">      db.collection(<span class="string">'tickets'</span>).insertOne(payload, (err, ticket) =&gt; &#123;</div><div class="line">        <span class="keyword">if</span> (err) &#123;</div><div class="line">          reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'an error occured registring a ticket, err:'</span> + err))</div><div class="line">        &#125;</div><div class="line">        resolve(ticket)</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> getOrderById = <span class="function">(<span class="params">orderId</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> ObjectID = container.resolve(<span class="string">'ObjectID'</span>)</div><div class="line">      <span class="keyword">const</span> query = &#123;<span class="attr">_id</span>: <span class="keyword">new</span> ObjectID(orderId)&#125;</div><div class="line">      <span class="keyword">const</span> response = <span class="function">(<span class="params">err, order</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">if</span> (err) &#123;</div><div class="line">          reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'An error occuered retrieving a order, err: '</span> + err))</div><div class="line">        &#125;</div><div class="line">        resolve(order)</div><div class="line">      &#125;</div><div class="line">      db.collection(<span class="string">'booking'</span>).findOne(query, &#123;&#125;, response)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> disconnect = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    db.close()</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.create(&#123;</div><div class="line">    makeBooking,</div><div class="line">    getOrderById,</div><div class="line">    generateTicket,</div><div class="line">    disconnect</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> connect = <span class="function">(<span class="params">container</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">if</span> (!container.resolve(<span class="string">'database'</span>)) &#123;</div><div class="line">      reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'connection db not supplied!'</span>))</div><div class="line">    &#125;</div><div class="line">    resolve(repository(container))</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="built_in">Object</span>.assign(&#123;&#125;, &#123;connect&#125;)</div></pre></td></tr></table></figure>
<p> <code>repository.js</code> æ–‡ä»¶å¹¶æ— ç‰¹åˆ«ä¹‹å¤„ï¼Œé™¤äº†è¿™å¯èƒ½æ˜¯æˆ‘ä»¬åœ¨ç³»åˆ—æ–‡ç« ä¸­ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨åˆ° <code>insertOne()</code> æ–¹æ³•ã€‚ä¸è¿‡æˆ‘æƒ³æŒ‡å‡ºä¸€ä»¶äº‹æƒ…ï¼Œç‰¹åˆ«æ˜¯åœ¨ <code>makeBooking()</code> æ–¹æ³•ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ° payload ä½¿ç”¨äº†æ•´ä¸ªæ•°æ®æ¨¡å‹å¯¹è±¡ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è¿™æ ·ç”¨ï¼Ÿè¿™æ ·æ˜¯å¦ä¼šæœ‰å¤ªå¤šçš„å†—ä½™ä¿¡æ¯ï¼Ÿ</p>
<p>æ²¡é”™ï¼Œè¿™æ ·ä¼šé€ æˆæ•°æ®å†—ä½™ï¼ŒåŒæ—¶ä¹Ÿä¸æ˜¯æœ€å¥½çš„å®ç°æ–¹å¼ï¼Œä½†æ˜¯æˆ‘ä»¬ç¡®å®æœ‰ç†ç”±è¿™æ ·åšï¼Œä¸è¿‡å¾—ç­‰åˆ°ä¸‹å›æˆ‘æ‰ä¼šå‘Šè¯‰ä½ ä¸ºä»€ä¹ˆï¼Œå› ä¸ºä¸€äº›æœ‰è¶£çš„äº‹æƒ…å³å°†å‘ç”Ÿã€‚</p>
<p>å¦‚æœä½ å¾ˆå¥½å¥‡ï¼Œé‚£ä¹ˆæˆ‘å¯ä»¥å…ˆç»™ä½ ç•™ä¸€ç‚¹ç‚¹æç¤ºğŸ˜</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">  ----------------------------------------</div><div class="line"> |                                        |</div><div class="line"> |                                        v</div><div class="line"> |                       Jane  ------(went to)----------</div><div class="line"> |                         |                            |</div><div class="line"> |                         | (loyal vistor)             |</div><div class="line"> |                         v                            v</div><div class="line">Joe --(normal visitor)--&gt; Movie Name &lt;--(displayed)-- Plaza Morelia</div><div class="line">                            |                           |</div><div class="line">                            |  (format)                 | (city)</div><div class="line">                            v                           v</div><div class="line">                           4DX                       Morelia</div></pre></td></tr></table></figure>
<p>å‰é¢æåˆ°æˆ‘ä»¬ä¼šä¸ä¸¤ä¸ªå¤–éƒ¨æœåŠ¡è¿›è¡Œäº¤äº’ï¼Œå…ˆç¨å¾®çœ‹ä¸€ä¸‹è¿™äº›å¤–éƒ¨æœåŠ¡éœ€è¦åšä»€ä¹ˆã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"># for the payment service we will need to implement something like the following</div><div class="line"></div><div class="line">module.exports = (paymentOrder) =&gt; &#123;</div><div class="line">  return new Promise((resolve, reject) =&gt; &#123;</div><div class="line">    supertest('url to the payment service')</div><div class="line">      .get('/makePurchase')</div><div class="line">      .send(&#123;paymentOrder&#125;)</div><div class="line">      .end((err, res) =&gt; &#123;</div><div class="line">        if (err) &#123;</div><div class="line">          reject(new Error('An error occured with the payment service, err: ' + err))</div><div class="line">        &#125;</div><div class="line">        resolve(res.body.payment)</div><div class="line">      &#125;)</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"># since we haven't made the payment service yet, let's make something simple to fulfill the article example, like the following    </div><div class="line"></div><div class="line">module.exports = (paymentOrder) =&gt; &#123;</div><div class="line">  return new Promise((resolve, reject) =&gt; &#123;</div><div class="line">    resolve(&#123;orderId: Math.floor((Math.random() * 1000) + 1)&#125;)</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"># for the notification service, at the moment we don't need any information from this service we will not implement it, this service will have the task for sending an email, sms or another notification, but we will make this service in the next chapter.</div></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº†æœ¬ç« å¾®æœåŠ¡çš„æ„å»ºå·¥ä½œï¼Œç°åœ¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤ï¼Œæ‰§è¡Œä»£ç åº“ä¸­çš„æ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ bash &lt; start_service</div></pre></td></tr></table></figure>
<p>ä»¥ä¿è¯æˆ‘ä»¬çš„å¾®æœåŠ¡åœ¨ docker å®¹å™¨ä¸­å®Œæ•´å¯ç”¨ï¼Œå¹¶å¼€å§‹<strong>é›†æˆæµ‹è¯•</strong>ã€‚</p>
<h1 id="æœ¬ç« å›é¡¾"><a href="#æœ¬ç« å›é¡¾" class="headerlink" title="æœ¬ç« å›é¡¾"></a>æœ¬ç« å›é¡¾</h1><p>æˆ‘ä»¬åšäº†ä»€ä¹ˆâ€¦</p>
<p>å¦‚æœä½ çœ‹äº†ä¹‹å‰çš„å‡ ç¯‡æ–‡ç« ï¼Œé‚£ä¹ˆæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªå¦‚ä¸‹çš„ç³»ç»Ÿæ¶æ„å›¾ï¼š</p>
<p><img src="https://img.zvz.im/imgs/2019/06/eac76015e41c1aa8.png" alt=""></p>
<p>ä½ å¯ä»¥çœ‹åˆ°ç³»ç»Ÿå·²ç»åŸºæœ¬æˆå½¢äº†ï¼Œåªæ˜¯æŸäº›éƒ¨åˆ†è¿˜æ˜¯æœ‰ç‚¹ä¸å¯¹ï¼Œé‚£å°±æ˜¯åœ¨ <strong>worker1</strong> å’Œ <strong>worker2</strong> ä¸­æˆ‘ä»¬æ²¡æœ‰è¿è¡Œä»»ä½•å¾®æœåŠ¡ã€‚é‚£æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰åœ¨è¿™äº› <strong>docker-machines</strong> ä¸­åˆ›å»ºä»»ä½•çš„æœåŠ¡ï¼Œä¸è¿‡ä»¥åä¼šå»åšçš„ã€‚</p>
<p>åœ¨<strong>å½±é™¢å¾®æœåŠ¡æ¶æ„</strong>ä¸­ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šå®Œæˆäº†ä¸‹å›¾ä¸­çš„éƒ¨åˆ†ï¼š</p>
<p><img src="https://img.zvz.im/imgs/2019/06/82a13f9a82e55315.png" alt=""></p>
<p>æˆ‘ä»¬åˆšåˆšå®Œæˆäº†<strong>è®¢ç¥¨æœåŠ¡</strong>ï¼Œè€Œä¸”å®ç°äº†ç®€æ˜“ç‰ˆçš„<strong>æ”¯ä»˜æœåŠ¡</strong>å’Œ<strong>é€šçŸ¥æœåŠ¡</strong>ã€‚</p>
<p>åœ¨æœ¬ç« ä¸­æˆ‘ä»¬éƒ½åšäº†ä»€ä¹ˆäº‹æƒ…Â¿ ğŸ¤” ?ï¼Œæˆ‘ä»¬å­¦ä¹ äº†<strong>ä¾èµ–æ³¨å…¥</strong>ï¼Œæ¥è§¦äº†ä¸€ç‚¹<strong>SOLIDåŸåˆ™</strong>å’Œ<strong>æ§åˆ¶åè½¬</strong>çš„æ¦‚å¿µï¼Œè¿˜ä½¿ç”¨ <strong>NodeJS</strong> å®Œæˆäº†å¯¹å¾®æœåŠ¡çš„ç¬¬ä¸€ä¸ª<strong>POST è¯·æ±‚</strong>ï¼Œæˆ‘ä»¬è¿˜å­¦ä¹ åˆ°å¦‚ä½•ä½¿ç”¨<strong>joi</strong>åº“è¿›è¡Œå¯¹è±¡å’Œæ•°æ®çš„æ ¡éªŒã€‚</p>
<p>æˆ‘ä»¬å·²ç»å­¦ä¹ äº†è®¸å¤š<strong>NodeJS</strong>å¼€å‘çš„ä»£ç ï¼Œä¸è¿‡æˆ‘ä»¬ä»ç„¶æœ‰å¾ˆå¤šå¯åšå’Œå¯å­¦ä¹ çš„äº‹æƒ…ï¼Œè¿™å„¿ä»…ä»…åªæ˜¯å…¶ä¸­ä¸€å°éƒ¨åˆ†è€Œå·²ã€‚å¸Œæœ›å®ƒå±•ç¤ºå‡ºäº†ä¸€äº›æœ‰è¶£è€Œæœ‰ç”¨çš„ä¸œè¥¿ï¼Œä½¿ä½ åœ¨å·¥ä½œä¸­èƒ½å¤Ÿè¿ç”¨åˆ° <strong>Docker å’Œ NodeJS</strong> çš„ç›¸å…³æŠ€æœ¯ã€‚</p>
<p>ç¿»è¯‘è‡ªï¼š<a href="https://medium.com/@cramirez92/build-a-nodejs-cinema-booking-microservice-and-deploying-it-with-docker-part-3-9c384e21fbe0" target="_blank" rel="external">Build a NodeJS cinema booking microservice and deploying it with docker (part 3)</a></p>
<p><a href="https://log.zvz.im/2017/05/24/nodejs-cinema-microservice-part1/">ç³»åˆ—æ–‡ç«  - Part 1</a><br><a href="https://log.zvz.im/2017/07/17/nodejs-cinema-microservice-part2/">ç³»åˆ—æ–‡ç«  - Part 2</a></p>

      

      
        
    </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/10/25/PHP-SOLID-principles/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          é¢å‘å¯¹è±¡è®¾è®¡çš„äº”ä¸ªé¦–è¦åŸåˆ™
        
      </div>
    </a>
  
  
    <a href="/2017/07/17/nodejs-cinema-microservice-part2/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">ç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡å¹¶éƒ¨ç½²åˆ° docker ä¸Š â€” Part 2</div>
    </a>
  
</nav>

  
</article>

<script type='text/javascript'>window.notIndexPage = true;</script>


<section id="comments">
  <div id="disqus_thread">
    <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'imzvz'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>
    Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
  </div>
</section>
</section>
        <aside id="sidebar">
  <nav class="menus">
  	<ul>
  		<li><a href="/"><i class="icon icon-home"></i></a></li>
  		
			<li><a href="/archives"><i class="icon icon-fenlei"></i></a></li>
  		
  		
			<li><a href="/tags"><i class="icon icon-tag"></i></a></li>
  		
  		
  	</ul>
  </nav>
  <a id="go-top" href="#"><i class="icon icon-up"></i></a>
</aside>
      </div>
      <footer id="footer">
  
	<div id="footer-info" class="inner">
	Linked with:&nbsp;&nbsp;&nbsp; 
	<a href="http://mritd.me" target="_blank">mritd.me</a>&nbsp;&nbsp;&nbsp;
	<a href="https://www.mghio.cn" target="_blank">mghio's blog</a>&nbsp;&nbsp;&nbsp;
	<a href="https://sillydong.com" target="_blank">å‚»ä¸œã®å­¦ä¹ ç¬”è®°</a>&nbsp;&nbsp;&nbsp;
	</div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tag</a>
  
</nav>
    
<script>
  var disqus_shortname = 'imzvz';
  
  var disqus_url = 'http://log.zvz.im/2017/10/17/nodejs-cinema-microservice-part3/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>

<script>
  if(window.notIndexPage)
  $(function(){
    $.get('//manage.zvz.im/api/posts/adv', function(res) {
      if(res.data.length) {
        $.each(res.data, function(idx, adv) {
          if(idx == 0) {
            if($('h2:first').length > 0) {
              $(adv).insertBefore('h2:first');
              return;
            }
          }
          $(adv).insertAfter('.article-inner');
        });
      }
    });
  });
</script>



  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/require.min.js"></script>
<script src="/js/script.js"></script>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>



  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>