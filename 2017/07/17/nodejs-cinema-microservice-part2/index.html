<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>ç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡å¹¶éƒ¨ç½²åˆ° docker ä¸Š â€” Part 2 | Z - Computer &amp; Programming Technology</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="æœ¬æ–‡æ˜¯ã€Œä½¿ç”¨ NodeJS æ„å»ºå½±é™¢å¾®æœåŠ¡ã€ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« ã€‚

## ç¬¬ä¸€ç« å¿«é€Ÿå›é¡¾
æˆ‘ä»¬è®²äº†ä»€ä¹ˆæ˜¯å¾®æœåŠ¡
æˆ‘ä»¬å¯¹æ¯”äº†å¾®æœåŠ¡çš„åˆ©ä¸å¼Š
æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªå½±é™¢å¾®æœåŠ¡çš„æ¶æ„
æˆ‘ä»¬ä½¿ç”¨ RAML å®šä¹‰äº†ç”µå½±æœåŠ¡ API çš„æŠ€æœ¯è§„æ ¼
æˆ‘ä»¬ä½¿ç”¨ NodeJS å’Œ ExpressJS å¼€å‘äº† ç”µå½±æœåŠ¡ API
æˆ‘ä»¬é’ˆå¯¹ API åšäº†å•å…ƒæµ‹è¯•
æˆ‘ä»¬å°† API ç»„æˆä¸€ä¸ªæœåŠ¡ï¼Œå¹¶ä½¿æˆ‘ä»¬çš„ç”µå½±æœåŠ¡è¿è¡Œåœ¨ Docke">
<meta property="og:type" content="article">
<meta property="og:title" content="ç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡å¹¶éƒ¨ç½²åˆ° docker ä¸Š â€” Part 2">
<meta property="og:url" content="http://log.zvz.im/2017/07/17/nodejs-cinema-microservice-part2/index.html">
<meta property="og:site_name" content="Z - Computer & Programming Technology">
<meta property="og:description" content="æœ¬æ–‡æ˜¯ã€Œä½¿ç”¨ NodeJS æ„å»ºå½±é™¢å¾®æœåŠ¡ã€ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« ã€‚

## ç¬¬ä¸€ç« å¿«é€Ÿå›é¡¾
æˆ‘ä»¬è®²äº†ä»€ä¹ˆæ˜¯å¾®æœåŠ¡
æˆ‘ä»¬å¯¹æ¯”äº†å¾®æœåŠ¡çš„åˆ©ä¸å¼Š
æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªå½±é™¢å¾®æœåŠ¡çš„æ¶æ„
æˆ‘ä»¬ä½¿ç”¨ RAML å®šä¹‰äº†ç”µå½±æœåŠ¡ API çš„æŠ€æœ¯è§„æ ¼
æˆ‘ä»¬ä½¿ç”¨ NodeJS å’Œ ExpressJS å¼€å‘äº† ç”µå½±æœåŠ¡ API
æˆ‘ä»¬é’ˆå¯¹ API åšäº†å•å…ƒæµ‹è¯•
æˆ‘ä»¬å°† API ç»„æˆä¸€ä¸ªæœåŠ¡ï¼Œå¹¶ä½¿æˆ‘ä»¬çš„ç”µå½±æœåŠ¡è¿è¡Œåœ¨ Docke">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/f142eea98b22201f.png">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/6858ab638d364e2d.png">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/0d98f20c7725bd61.png">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/5c43c08b82f70617.png">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/7de1fafcdbfff1a2.png">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/3f1a1b0ba2e94f39.png">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/213cd97d135f56e1.png">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/9306e91bf244845c.png">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/80065700ac28226e.png">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/15b430ee5d0b7082.png">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/89fcb6d89df7cf8a.gif">
<meta property="og:image" content="https://img.zvz.im/imgs/2019/06/f142eea98b22201f.png">
<meta property="og:updated_time" content="2024-05-12T13:15:10.157Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡å¹¶éƒ¨ç½²åˆ° docker ä¸Š â€” Part 2">
<meta name="twitter:description" content="æœ¬æ–‡æ˜¯ã€Œä½¿ç”¨ NodeJS æ„å»ºå½±é™¢å¾®æœåŠ¡ã€ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« ã€‚

## ç¬¬ä¸€ç« å¿«é€Ÿå›é¡¾
æˆ‘ä»¬è®²äº†ä»€ä¹ˆæ˜¯å¾®æœåŠ¡
æˆ‘ä»¬å¯¹æ¯”äº†å¾®æœåŠ¡çš„åˆ©ä¸å¼Š
æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªå½±é™¢å¾®æœåŠ¡çš„æ¶æ„
æˆ‘ä»¬ä½¿ç”¨ RAML å®šä¹‰äº†ç”µå½±æœåŠ¡ API çš„æŠ€æœ¯è§„æ ¼
æˆ‘ä»¬ä½¿ç”¨ NodeJS å’Œ ExpressJS å¼€å‘äº† ç”µå½±æœåŠ¡ API
æˆ‘ä»¬é’ˆå¯¹ API åšäº†å•å…ƒæµ‹è¯•
æˆ‘ä»¬å°† API ç»„æˆä¸€ä¸ªæœåŠ¡ï¼Œå¹¶ä½¿æˆ‘ä»¬çš„ç”µå½±æœåŠ¡è¿è¡Œåœ¨ Docke">
<meta name="twitter:image" content="https://img.zvz.im/imgs/2019/06/f142eea98b22201f.png">
  
    <link rel="alternative" href="/atom.xml" title="Z - Computer &amp; Programming Technology" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.geekzu.org/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8NRBEZPWYN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8NRBEZPWYN');
</script>


  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-8768699638326268",
      enable_page_level_ads: true
    });
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <div class="outer">
        <section id="main"><article id="post-nodejs-cinema-microservice-part2" class="article article-type-post" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡å¹¶éƒ¨ç½²åˆ° docker ä¸Š â€” Part 2
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/07/17/nodejs-cinema-microservice-part2/" class="article-date">
  <time datetime="2017-07-17T14:18:23.000Z" itemprop="datePublished">2017-07-17</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/tags/Nodejs/">Nodejs</a>
  </div>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>æœ¬æ–‡æ˜¯ã€Œä½¿ç”¨ NodeJS æ„å»ºå½±é™¢å¾®æœåŠ¡ã€ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« ã€‚</p>
</blockquote>
<h3 id="ç¬¬ä¸€ç« å¿«é€Ÿå›é¡¾"><a href="#ç¬¬ä¸€ç« å¿«é€Ÿå›é¡¾" class="headerlink" title="## ç¬¬ä¸€ç« å¿«é€Ÿå›é¡¾"></a>## ç¬¬ä¸€ç« å¿«é€Ÿå›é¡¾</h3><ul>
<li>æˆ‘ä»¬è®²äº†<strong>ä»€ä¹ˆæ˜¯å¾®æœåŠ¡</strong></li>
<li>æˆ‘ä»¬å¯¹æ¯”äº†<strong>å¾®æœåŠ¡</strong>çš„<strong>åˆ©</strong>ä¸<strong>å¼Š</strong></li>
<li>æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ª<strong>å½±é™¢å¾®æœåŠ¡çš„æ¶æ„</strong></li>
<li>æˆ‘ä»¬ä½¿ç”¨ <strong>RAML</strong> å®šä¹‰äº†<strong>ç”µå½±æœåŠ¡ API</strong> çš„æŠ€æœ¯è§„æ ¼</li>
<li>æˆ‘ä»¬ä½¿ç”¨ <strong>NodeJS å’Œ ExpressJS</strong> å¼€å‘äº† <strong>ç”µå½±æœåŠ¡ API</strong></li>
<li>æˆ‘ä»¬é’ˆå¯¹ API åšäº†<strong>å•å…ƒæµ‹è¯•</strong></li>
<li>æˆ‘ä»¬å°† API ç»„æˆä¸€ä¸ªæœåŠ¡ï¼Œå¹¶ä½¿æˆ‘ä»¬çš„<strong>ç”µå½±æœåŠ¡</strong>è¿è¡Œåœ¨ <strong>Docker</strong> å®¹å™¨ä¸­</li>
<li>æˆ‘ä»¬å¯¹è¿è¡Œåœ¨ <strong>Docker</strong> ä¸­çš„<strong>ç”µå½±æœåŠ¡</strong>åšäº†<strong>é›†æˆæµ‹è¯•</strong></li>
</ul>
<p>å¦‚æœä½ è¿˜æ²¡æœ‰é˜…è¯»è¿‡ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œä½ å¯ä»¥<a href="https://log.zvz.im/2017/05/24/nodejs-cinema-microservice-part1/">å»è¿™é‡Œçœ‹çœ‹</a>ğŸ‘€ã€‚</p>
<p>åœ¨æœ¬ç¯‡ä¸­æˆ‘ä»¬å°†ç»§ç»­æ„å»ºæˆ‘ä»¬çš„<strong>å½±é™¢å¾®æœåŠ¡</strong>ï¼Œè¿™æ¬¡æˆ‘ä»¬å°†è¿›è¡Œ<strong>å½±é™¢ç›®å½•æœåŠ¡</strong>çš„å¼€å‘ï¼Œä»¥å®Œæˆä¸‹å›¾ä¸­çš„åŠŸèƒ½ã€‚</p>
<p><img src="https://img.zvz.im/imgs/2019/06/f142eea98b22201f.png" alt=""><br><a id="more"></a><br>æˆ‘ä»¬å°†ä½¿ç”¨åˆ°ä»¥ä¸‹æŠ€æœ¯ï¼š</p>
<ul>
<li>NodeJS version 7.2.0</li>
<li>MongoDB 3.4.1</li>
<li>Docker for Mac 1.13</li>
</ul>
<p>è¦è·Ÿä¸Šæœ¬æ–‡çš„è¿›åº¦æœ‰ä»¥ä¸‹è¦æ±‚ï¼š</p>
<ul>
<li>å·²ç»å®Œæˆ<a href="https://log.zvz.im/2017/05/24/nodejs-cinema-microservice-part1/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­çš„ä¾‹å­ä»£ç </li>
</ul>
<p>å¦‚æœä½ è¿˜æ²¡æœ‰å®Œæˆè¿™äº›ä»£ç ï¼Œæˆ‘å·²ç»å°†ä»£ç ä¼ åˆ°äº† github ä¸Šï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨<a href="https://github.com/Crizstian/cinema-microservice/tree/step-1" target="_blank" rel="external">ä»£ç åº“</a>åˆ†æ”¯ <strong>step-1</strong>ã€‚</p>
<h2 id="å¾®æœåŠ¡å®‰å…¨ä»¥åŠ-Â¿-HTTP-2"><a href="#å¾®æœåŠ¡å®‰å…¨ä»¥åŠ-Â¿-HTTP-2" class="headerlink" title="# å¾®æœåŠ¡å®‰å…¨ä»¥åŠ Â¿ HTTP/2 ?"></a># å¾®æœåŠ¡å®‰å…¨ä»¥åŠ Â¿ HTTP/2 ?</h2><p>åœ¨ç¬¬ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€å•çš„å¾®æœåŠ¡ï¼Œå®ƒä½¿ç”¨çš„æ˜¯ HTTP/1.1 åè®®ã€‚å¯¹äºå·²æœ‰ 15 å¹´å†å²çš„ HTTP åè®®æ¥è¯´ï¼Œ<strong>HTTP/2 æ˜¯ç¬¬ä¸€æ¬¡å¤§å‡çº§</strong>ï¼Œå®ƒè¢«é«˜åº¦ä¼˜åŒ–ä¸”æ•ˆç‡æ›´é«˜ã€‚<strong>HTTP/2 æ˜¯æœ€æ–°çš„ç½‘ç»œæ ‡å‡†</strong>ï¼Œå®ƒèµ·æºäºè°·æ­Œçš„ SPDY åè®®ã€‚ç°åœ¨å·²æœ‰è®¸å¤šçƒ­é—¨ç«™ç‚¹åœ¨ä½¿ç”¨å®ƒï¼Œå¹¶ä¸”å‡ ä¹æ‰€æœ‰ä¸»æµæµè§ˆå™¨éƒ½æ”¯æŒè¯¥åè®®ã€‚</p>
<p><strong>è¦å®ç° HTTP/2ï¼Œåªéœ€æ»¡è¶³ä»¥ä¸‹ä¸€äº›è§„åˆ™ã€‚</strong></p>
<ul>
<li>å®ƒä»…æ”¯æŒ HTTPS åè®®ï¼ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„ SSL å®‰å…¨è¯ä¹¦ï¼‰</li>
<li>å®ƒæ˜¯å‘åå…¼å®¹çš„ã€‚å½“æµè§ˆå™¨æˆ–è®¾å¤‡ä¸æ”¯æŒ <strong>HTTP/2</strong> æ—¶ï¼Œå®ƒèƒ½å›é€€åˆ° HTTP/1.1</li>
<li>å®ƒä¼šå¸¦æ¥æå¤§çš„æ€§èƒ½æå‡</li>
<li>å®ƒä¸éœ€è¦å®¢æˆ·ç«¯åšä»»ä½•æ”¹åŠ¨ï¼Œåªéœ€è¦æœåŠ¡ç«¯åšä¸€ä¸ªåŸºç¡€å®ç°</li>
<li>ä¸€äº›æœ‰è¶£çš„æ–°ç‰¹æ€§èƒ½æé«˜ç«™ç‚¹çš„åŠ è½½é€Ÿåº¦ï¼Œåœ¨ HTTP 1.1 ä¸­è¿™ç§æ–¹å¼æ˜¯æ— æ³•æƒ³è±¡çš„</li>
</ul>
<h3 id="ä¸€ä¸ªå¯ç”¨äº†-HTTP-2-çš„å¾®æœåŠ¡ç½‘ç»œæ¶æ„"><a href="#ä¸€ä¸ªå¯ç”¨äº†-HTTP-2-çš„å¾®æœåŠ¡ç½‘ç»œæ¶æ„" class="headerlink" title="ä¸€ä¸ªå¯ç”¨äº† HTTP/2 çš„å¾®æœåŠ¡ç½‘ç»œæ¶æ„"></a>ä¸€ä¸ªå¯ç”¨äº† HTTP/2 çš„å¾®æœåŠ¡ç½‘ç»œæ¶æ„</h3><p><em>è¿™æ„å‘³ç€æˆ‘ä»¬è¦åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´å¯ç”¨ä¸€ä¸ªå•ç‹¬çš„è¿æ¥ï¼Œç„¶ååœ¨â€œç½‘ç»œä¸­â€åˆ©ç”¨ç±»ä¼¼ Y è½´åˆ†ç‰‡ï¼ˆ Y-axis sharding ä¼šåœ¨æœ¬ç³»åˆ—æ–‡ç« çš„åŠ¨æ€æ‰©å®¹ç¯‡è®²åˆ°æ›´å¤šï¼‰çš„æ–¹å¼äº«å— HTTP/2 å¸¦æ¥çš„æ€§èƒ½æå‡ï¼ŒåŒæ—¶è¿˜èƒ½äº«å—å¾®æœåŠ¡æ¶æ„åœ¨è¿è¥å’Œå¼€å‘ä¸Šå¸¦æ¥çš„å¥½å¤„ã€‚</em></p>
<p>ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ä½¿ç”¨æœ€æ–°çš„ <strong>HTTP/2 åè®®</strong>ï¼Ÿå› ä¸ºä½œä¸ºä¸€åå¥½çš„å¼€å‘è€…ï¼Œæˆ‘ä»¬ä¸ä»…è¦ä¿éšœåº”ç”¨ï¼ŒåŸºç¡€è®¾æ–½å’Œé€šä¿¡çš„å®‰å…¨ï¼Œå°½æœ€å¤§åŠªåŠ›æ¥é˜²æ­¢æ¶æ„æ”»å‡»ï¼›è€Œä¸”ä½œä¸ºä¸€åå¥½çš„å¼€å‘è€…ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥é‡‡ç”¨å¯¹æˆ‘ä»¬æœ‰åˆ©çš„æœ€ä½³å®è·µæ–¹å¼ï¼Œæ¯”å¦‚ä½¿ç”¨ HTTP/2 ã€‚</p>
<p>å¾®æœåŠ¡å®‰å…¨çš„ä¸€äº›å¥½çš„å®è·µæ–¹å¼å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å®‰å…¨ï¼Œæ˜¯å¾®æœåŠ¡åº”ç”¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ä¸­çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ã€‚æ ¹æ® 451 Research çš„ä¸€é¡¹åä¸º<a href="https://451research.com/blog/64-451-research-presents-2016-software-defined-infrastructure-sdi-outlook" target="_blank" rel="external">2016è½¯ä»¶å®šä¹‰è®¾æ–½å±•æœ›</a>çš„è°ƒæŸ¥ï¼Œåœ¨æœªæ¥çš„ 12 æœˆå†…ï¼Œè¿‘ 45% çš„ä¼ä¸šå·²ç»æˆ–è®¡åˆ’å®ç°åŸºäºå®¹å™¨çš„åº”ç”¨éƒ¨ç½²ã€‚ç”±äº DevOps å®è·µåœ¨ä¼ä¸šä¸­å–å¾—äº†ç¨³å›ºåœ°ä½ï¼Œå®¹å™¨åº”ç”¨å˜å¾—æ›´åŠ æµè¡Œï¼Œå®‰å…¨é¡¾é—®ä»¬éœ€è¦çŸ¥é“å¦‚ä½•ä¿éšœè¿™äº›åº”ç”¨çš„å®‰å…¨ã€‚â€”â€” <a href="http://www.darkreading.com/endpoint/rethinking-application-security-with-microservices-architectures-/a/d-id/1325155" target="_blank" rel="external">@Ranga Rajagopalan</a></p>
</blockquote>
<ul>
<li>å‘ç°å¹¶ç›‘æ§æœåŠ¡é—´é€šä¿¡</li>
<li>åˆ†æ®µå¹¶éš”ç¦»åº”ç”¨ä¸æœåŠ¡</li>
<li>å¯¹ä¼ è¾“ä¸­çš„æ•°æ®ä»¥åŠå­˜å‚¨çš„æ•°æ®è¿›è¡ŒåŠ å¯†</li>
</ul>
<p>æˆ‘ä»¬å°†å¯¹å¾®æœåŠ¡é€šä¿¡è¿›è¡ŒåŠ å¯†ä»¥å®ç°å®‰å…¨é€šä¿¡ï¼Œå¹¶æå‡å…¬ç½‘æµé‡çš„å®‰å…¨æ€§ï¼Œè¿™æ˜¯æˆ‘ä»¬ä½¿ç”¨ <strong>HTTP/2</strong> çš„åŸå› ä¹‹ä¸€ï¼Œä¸ºäº†æ›´å¥½çš„æ€§èƒ½ä»¥åŠå®‰å…¨æå‡ã€‚</p>
<h2 id="å¾®æœåŠ¡çš„-HTTP-2-å®ç°"><a href="#å¾®æœåŠ¡çš„-HTTP-2-å®ç°" class="headerlink" title="# å¾®æœåŠ¡çš„ HTTP/2 å®ç°"></a># å¾®æœåŠ¡çš„ HTTP/2 å®ç°</h2><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ›´æ–°ä¸‹ä¸Šä¸€ç« çš„<strong>ç”µå½±æœåŠ¡</strong>ï¼Œä»¥æ”¯æŒ <strong>HTTP/2</strong> åè®®ï¼Œåœ¨æ­¤ä¹‹å‰æˆ‘ä»¬åœ¨ <strong>config</strong> ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª <strong>ssl</strong> ç›®å½•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">movies-service/config:/ $ mkdir ssl</div><div class="line">movies-service/config:/ $ cd ssl</div></pre></td></tr></table></figure>
<p>è¿›å…¥ <strong>ssl</strong> ç›®å½•åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè‡ªç­¾åçš„ SSL è¯ä¹¦ï¼Œç”¨äºå®ç° <strong>HTTP/2</strong> åè®®ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Let's generate the server pass key</span></div><div class="line"></div><div class="line">ssl/: $ openssl genrsa -des3 -passout pass:x -out server.pass.key 2048 </div><div class="line"><span class="comment"># now generate the server key from the pass key</span></div><div class="line"></div><div class="line">ssl/: $ openssl rsa -passin pass:x -in server.pass.key -out server.key</div><div class="line"><span class="comment"># we remove the pass key</span></div><div class="line"></div><div class="line">ssl/: $ rm server.pass.key</div><div class="line"><span class="comment"># now let's create the .csr file</span></div><div class="line">ssl/: $ openssl req -new -key server.key -out server.csr </div><div class="line">...</div><div class="line">Country Name (2 letter code) [AU]:MX</div><div class="line">State or Province Name (full name) [Some-State]:Michoacan </div><div class="line">... </div><div class="line">A challenge password []: </div><div class="line">...</div><div class="line"><span class="comment"># now let's create the .crt file</span></div><div class="line">ssl/: $ openssl x509 -req -sha256 -days 365 -in server.csr -signkey server.key -out server.crt</div></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å®‰è£… <strong>SPDY</strong> åŒ…ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cinema-catalog-service/: $ npm i -S spdy --silent</div></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬åœ¨ <code>ssl/</code> ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª <code>index.js</code> æ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼Œæˆ‘ä»¬åœ¨ä»£ç ä¸­åŠ è½½ key å’Œ cert æ–‡ä»¶ï¼Œè¿™é‡Œæ˜¯æˆ‘ä»¬ä¸ºæ•°ä¸å¤šåœ°ä½¿ç”¨ <code>fs.readFileSync()</code> çš„åœ°æ–¹ä¹‹ä¸€ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">key</span>: fs.readFileSync(<span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/server.key`</span>),</div><div class="line">  <span class="attr">cert</span>: fs.readFileSync(<span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/server.crt`</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬è¿˜è¦ä¿®æ”¹ä¸€äº›æ–‡ä»¶ï¼Œç¬¬ä¸€ä¸ªæ–‡ä»¶æ˜¯ <code>config.js</code> ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> dbSettings = &#123; ... &#125;</div><div class="line"><span class="comment">// The first modification is adding the ssl certificates to the </span></div><div class="line"><span class="comment">// serverSettings</span></div><div class="line"><span class="keyword">const</span> serverSettings = &#123;</div><div class="line">  <span class="attr">port</span>: process.env.PORT || <span class="number">3000</span>,</div><div class="line">  <span class="attr">ssl</span>: <span class="built_in">require</span>(<span class="string">'./ssl'</span>)</div><div class="line">&#125;</div><div class="line"><span class="built_in">module</span>.exports = <span class="built_in">Object</span>.assign(&#123;&#125;, &#123; dbSettings, serverSettings &#125;)</div></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ä¿®æ”¹ <code>server.js</code> ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">const spdy = <span class="built_in">require</span>(<span class="string">'spdy'</span>)</div><div class="line"><span class="keyword">const</span> api = <span class="built_in">require</span>(<span class="string">'../api/movies'</span>)</div><div class="line"><span class="keyword">const</span> start = <span class="function">(<span class="params">options</span>) =&gt;</span> &#123;</div><div class="line">...</div><div class="line"> const app = express()</div><div class="line"> app.use(morgan(<span class="string">'dev'</span>))</div><div class="line"> app.use(helmet())</div><div class="line"> app.use(<span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</div><div class="line">   reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Something went wrong!, err:'</span> + err))</div><div class="line">   res.status(<span class="number">500</span>).send(<span class="string">'Something went wrong!'</span>)</div><div class="line"> &#125;)</div><div class="line"> api(app, options)</div><div class="line"> <span class="comment">// here is where we made the modifications, we create a spdy</span></div><div class="line"> <span class="comment">// server, then we pass the ssl certs, and the express app</span></div><div class="line"> <span class="keyword">const</span> server = spdy.createServer(options.ssl, app)</div><div class="line">      .listen(options.port, () =&gt; resolve(server))</div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"><span class="built_in">module</span>.exports = <span class="built_in">Object</span>.assign(&#123;&#125;, &#123;start&#125;)</div></pre></td></tr></table></figure>
<p>æœ€åä¿®æ”¹ <code>index.js</code> è¿™ä¸ªä¸»æ–‡ä»¶ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span></div><div class="line"><span class="keyword">const</span> &#123;EventEmitter&#125; = <span class="built_in">require</span>(<span class="string">'events'</span>)</div><div class="line"><span class="keyword">const</span> server = <span class="built_in">require</span>(<span class="string">'./server/server'</span>)</div><div class="line"><span class="keyword">const</span> repository = <span class="built_in">require</span>(<span class="string">'./repository/repository'</span>)</div><div class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./config/'</span>)</div><div class="line"><span class="keyword">const</span> mediator = <span class="keyword">new</span> EventEmitter()</div><div class="line">...</div><div class="line">mediator.on(<span class="string">'db.ready'</span>, (db) =&gt; &#123;</div><div class="line">  <span class="keyword">let</span> rep</div><div class="line">  repository.connect(db)</div><div class="line">    .then(<span class="function"><span class="params">repo</span> =&gt;</span> &#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'Connected. Starting Server'</span>)</div><div class="line">      rep = repo</div><div class="line">      <span class="keyword">return</span> server.start(&#123;</div><div class="line">        <span class="attr">port</span>: config.serverSettings.port,</div><div class="line">        <span class="comment">// here we pass the ssl options to the server.js file</span></div><div class="line">        ssl: config.serverSettings.ssl,</div><div class="line">        repo</div><div class="line">      &#125;)</div><div class="line">    &#125;)</div><div class="line">    .then(<span class="function"><span class="params">app</span> =&gt;</span> &#123; ... &#125;)</div><div class="line">&#125;)</div><div class="line">...</div></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„æŒ‡ä»¤é‡å»º docker é•œåƒï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker build -t movies-service .</div></pre></td></tr></table></figure>
<p>å†ä½¿ç”¨ä»¥ä¸‹å‚æ•°è¿è¡Œæˆ‘ä»¬çš„ docker é•œåƒ <code>moives-service</code> ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ docker run --name movies-service -p 443:3000 -d movies-service</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆæˆ‘ä»¬ç”¨ chrome æµè§ˆå™¨æµ‹è¯•ä¸€ä¸‹ï¼Œå¯ä»¥ç¡®è®¤æˆ‘ä»¬çš„ <strong>HTTP/2</strong> åè®®å·²ç»å®Œå…¨ç”Ÿæ•ˆäº†ã€‚</p>
<p><img src="https://img.zvz.im/imgs/2019/06/6858ab638d364e2d.png" alt=""></p>
<p>è€Œä¸”æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <strong>wireshark</strong> ä¹‹ç±»çš„æŠ“åŒ…å·¥å…·ç¡®è®¤ <strong>ssl</strong> ç¡®å®ç”Ÿæ•ˆäº†ã€‚</p>
<p><img src="https://img.zvz.im/imgs/2019/06/0d98f20c7725bd61.png" alt=""></p>
<h3 id="åœ¨å¾®æœåŠ¡ä¸Šå®ç°-JWT"><a href="#åœ¨å¾®æœåŠ¡ä¸Šå®ç°-JWT" class="headerlink" title="# åœ¨å¾®æœåŠ¡ä¸Šå®ç° JWT"></a># åœ¨å¾®æœåŠ¡ä¸Šå®ç° JWT</h3><p>å¦å¤–ä¸€ç§åŠ å¯†å¹¶ä¿éšœæˆ‘ä»¬çš„å¾®æœåŠ¡é€šä¿¡å®‰å…¨çš„æ–¹å¼æ˜¯ä½¿ç”¨ <code>json web token</code> åè®®ï¼Œæˆ‘ä»¬å°†åœ¨æœ¬ç³»åˆ—åé¢çš„æ–‡ç« ä¸­è®²åˆ°ğŸš‰ã€‚</p>
<h2 id="æ„å»ºå¾®æœåŠ¡"><a href="#æ„å»ºå¾®æœåŠ¡" class="headerlink" title="# æ„å»ºå¾®æœåŠ¡"></a># æ„å»ºå¾®æœåŠ¡</h2><p>åˆ°æ­¤ä¸ºæ­¢æˆ‘ä»¬å·²ç»çŸ¥é“äº†å¦‚ä½•å®ç° <strong>HTTP/2</strong> åè®®ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬ç»§ç»­æ„å»º<strong>å½±é™¢ç›®å½•æœåŠ¡</strong> ã€‚æˆ‘ä»¬ä¼šä½¿ç”¨ä¸<strong>ç”µå½±æœåŠ¡</strong>ä¸€æ ·çš„é¡¹ç›®ç»“æ„ï¼Œè®©æˆ‘ä»¬å°‘è®²è¯ğŸ—£å¤šç¼–ç ğŸ‘¨ğŸ»â€ğŸ’»ğŸ‘©ğŸ»â€ğŸ’»è¿™å°±å¹²èµ·æ¥ã€‚</p>
<p>åœ¨å¼€å§‹è®¾è®¡ API ä¹‹å‰ï¼Œè¿™æ¬¡æˆ‘ä»¬è¦å…ˆä¸ºæ•°æ®åº“è®¾è®¡ <strong>Mongo Schemas</strong>ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åˆ°ä»¥ä¸‹æ•°æ®åº“ï¼š</p>
<ul>
<li>Locationsï¼ˆå›½å®¶ï¼Œå·å¿å’ŒåŸå¸‚ï¼‰</li>
<li>Cinemasï¼ˆå½±é™¢ï¼Œæ”¾æ˜ è®¡åˆ’ï¼Œç”µå½±ï¼‰</li>
</ul>
<h3 id="æ¨¡å‹æ•°æ®è®¾è®¡"><a href="#æ¨¡å‹æ•°æ®è®¾è®¡" class="headerlink" title="# æ¨¡å‹æ•°æ®è®¾è®¡"></a># æ¨¡å‹æ•°æ®è®¾è®¡</h3><p>æœ¬æ–‡é‡ç‚¹å…³æ³¨äºæ„å»ºå¾®æœåŠ¡ï¼Œæ•…ä¸ä¼šåœ¨â€œæ¨¡å‹æ•°æ®è®¾è®¡â€ä¸ŠèŠ±å¤ªå¤šçš„æ—¶é—´ï¼Œåªä¼šå¼ºè°ƒæŸäº›éƒ¨åˆ†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># posible collections for the cinemas db.</div><div class="line"># For locations </div><div class="line">- countries</div><div class="line">- states</div><div class="line">- cities</div><div class="line"># For cinemas</div><div class="line">- cinemas</div><div class="line">- cinemaRooms</div><div class="line">- schedules</div></pre></td></tr></table></figure>
<p>å¯¹äºæˆ‘ä»¬çš„ <strong>Locations</strong> åº“æ¥è¯´ï¼Œä¸€ä¸ªå›½å®¶å¯ä»¥æœ‰å¤šä¸ªå·è€Œä¸€ä¸ªå·åˆ™å¯¹åº”ä¸€ä¸ªå›½å®¶ï¼Œæ‰€ä»¥è¿™æ˜¯<strong>ä¸€å¯¹å¤š</strong>çš„å…³ç³»ï¼Œå¯¹äºå·å’ŒåŸå¸‚æ¥è¯´ä¹Ÿæ˜¯ä¸€æ ·çš„å…³ç³»ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å…³ç³»å›¾ï¼š</p>
<p><img src="https://img.zvz.im/imgs/2019/06/5c43c08b82f70617.png" alt=""></p>
<p><img src="https://img.zvz.im/imgs/2019/06/7de1fafcdbfff1a2.png" alt=""></p>
<p>è¿™ç§å…³ç³»è¿˜é€‚ç”¨äºå¾ˆå¤šæƒ…å†µã€‚ä¸€ä¸ªåŸå¸‚æœ‰å¤šä¸ªç”µå½±é™¢ï¼Œä¸€ä¸ªç”µå½±é™¢å±äºä¸€ä¸ªåŸå¸‚ï¼›ä¸€ä¸ªæ”¾æ˜ å®¤æœ‰è®¸å¤šæ”¾æ˜ è®¡åˆ’ï¼Œä¸€ä¸ªæ”¾æ˜ è®¡åˆ’å±äºä¸€ä¸ªæ”¾æ˜ å®¤ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒä»¬ä¹‹é—´çš„å…³ç³»ã€‚</p>
<p><img src="https://img.zvz.im/imgs/2019/06/3f1a1b0ba2e94f39.png" alt=""></p>
<p>å¦‚æœç”µå½±é™¢æ•°ç»„æˆ–è€…æ”¾æ˜ è®¡åˆ’æ•°æ®å¢é•¿æ¯”è¾ƒæœ‰é™ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸Šå›¾ä¸­çš„å¼•ç”¨å…³ç³»ã€‚å‡è®¾ä¸€ä¸ªæ”¾æ˜ å®¤æ¯å¤©æœ€å¤šåªæœ‰ 5 ä¸ªæ”¾æ˜ è®¡åˆ’ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†æ”¾æ˜ è®¡åˆ’æ–‡æ¡£ç›´æ¥åµŒå…¥åˆ°å½±é™¢æ–‡æ¡£ä¸­å»ã€‚</p>
<blockquote>
<p>å†…åµŒæ•°æ®æ¨¡å‹å…è®¸åº”ç”¨å°†ç›¸å…³æ€§æ•°æ®ç‰‡æ–­å­˜æ”¾åœ¨åŒä¸€æ¡æ•°æ®åº“è®°å½•ä¸­ã€‚è¿™æ ·åšå¯ä½¿å¾—åº”ç”¨çš„å¸¸ç”¨æ“ä½œéœ€è¦æ›´å°‘çš„æŸ¥è¯¢å’Œæ›´æ–°ã€‚â€”â€” MongoDB Docs</p>
</blockquote>
<p><img src="https://img.zvz.im/imgs/2019/06/213cd97d135f56e1.png" alt=""></p>
<p>è¿™å°±æ˜¯æˆ‘ä»¬æ•°æ®åº“ç»“æ„è®¾è®¡çš„æœ€ç»ˆç»“æœã€‚</p>
<h3 id="å°†æ•°æ®å¯¼å…¥æ•°æ®åº“"><a href="#å°†æ•°æ®å¯¼å…¥æ•°æ®åº“" class="headerlink" title="# å°†æ•°æ®å¯¼å…¥æ•°æ®åº“"></a># å°†æ•°æ®å¯¼å…¥æ•°æ®åº“</h3><p>æˆ‘å·²ç»ä¸ºåˆšæ‰è®¾è®¡çš„æ•°æ®åº“ç»“æ„å‡†å¤‡äº†ä¸€äº›æ ·ä¾‹æ•°æ®ï¼Œåœ¨ github ä»“åº“çš„ <code>cinema-catalog-service/src/mock</code> ç›®å½•ä¸‹æœ‰ 4 ä¸ª JOSN æ–‡ä»¶ï¼Œä½ å¯ä»¥å°†å®ƒä»¬å¯¼å…¥åˆ°å½±é™¢æ•°æ®åº“ä¸­ï¼Œä¸è¿‡é¦–å…ˆæˆ‘ä»¬æ‰¾åˆ°æ•°æ®åº“ä¸»æœåŠ¡å™¨ï¼Œä¹‹åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># first we need to copy the files one by one or we can zip it and pass the zip file</div><div class="line">$ docker cp countries.json mongoNodeContainer:/tmp</div><div class="line">$ docker cp state.json mongoNodeContainer:/tmp</div><div class="line">$ docker cp city.json mongoNodeContainer:/tmp</div><div class="line">$ docker cp cinemas.json mongoNodeContainer:/tmp</div></pre></td></tr></table></figure>
<p>æ‰§è¡Œå®Œä¸Šé¢çš„å‘½ä»¤åï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠæ•°æ®å¯¼å…¥åˆ°æ•°æ®åº“ä¸­äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ docker exec mongoNode&#123;number&#125; bash -c &apos;mongoimport --db cinemas --collection countries --file /tmp/countries.json --jsonArray -u $MONGO_USER_ADMIN -p $MONGO_PASS_ADMIN --authenticationDatabase &quot;admin&quot;&apos;</div><div class="line"></div><div class="line">$ docker exec mongoNode&#123;number&#125; bash -c &apos;mongoimport --db cinemas --collection states --file /tmp/states.json --jsonArray -u $MONGO_USER_ADMIN -p $MONGO_PASS_ADMIN --authenticationDatabase &quot;admin&quot;&apos;</div><div class="line"></div><div class="line">$ docker exec mongoNode&#123;number&#125; bash -c &apos;mongoimport --db cinemas --collection cities --file /tmp/cities.json --jsonArray -u $MONGO_USER_ADMIN -p $MONGO_PASS_ADMIN --authenticationDatabase &quot;admin&quot;&apos;</div><div class="line"></div><div class="line">$ docker exec mongoNode&#123;number&#125; bash -c &apos;mongoimport --db cinemas --collection cinemas --file /tmp/cinemas.json --jsonArray -u $MONGO_USER_ADMIN -p $MONGO_PASS_ADMIN --authenticationDatabase &quot;admin&quot;&apos;</div></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»è®¾è®¡å¥½äº†æ•°æ®åº“ç»“æ„ï¼Œè€Œä¸”æ•°æ®ä¹Ÿå·²å¯¼å…¥å¯ä»¥æŸ¥è¯¢äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨å¼€å§‹ä¸º<strong>å½±é™¢ç›®å½•æœåŠ¡</strong>è®¾è®¡ APIï¼Œæœ‰ä¸€ç§å®šä¹‰è·¯ç”±çš„æ–¹æ³•æ˜¯ç”¨ä¸€å¥è¯æŠŠå®ƒä»¬è¡¨è¾¾å‡ºæ¥ï¼Œå¦‚ä¸‹ï¼š</p>
<ul>
<li>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŸå¸‚èƒ½å¤Ÿæ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„ç”µå½±é™¢ã€‚</li>
<li>æˆ‘ä»¬éœ€è¦è¿™äº›ç”µå½±é™¢å±•ç¤ºç”µå½±ä¸Šæ˜ ä¿¡æ¯ã€‚</li>
<li>æˆ‘ä»¬éœ€è¦ç”µå½±çš„é¦–æ˜ ä¿¡æ¯å¹¶å±•ç¤ºæ”¾æ˜ è®¡åˆ’ã€‚</li>
<li>æˆ‘ä»¬éœ€è¦æ”¾æ˜ è®¡åˆ’å¹¶æŸ¥çœ‹æ˜¯å¦æœ‰åº§ä½å¯ä¾›è®¢ç¥¨ã€‚</li>
</ul>
<p>æˆ‘ä»¬å‡è®¾ <strong>CinÃ©polis</strong> IT éƒ¨é—¨çš„å…¶ä»–å¼€å‘å°ç»„åœ¨åšå…¶ä»–çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œè€Œäº¤ç»™æˆ‘ä»¬çš„ä»»åŠ¡åªæ˜¯æŸ¥è¯¢è¯»å–æ•°æ®ï¼Œæˆ‘ä»¬è¿˜å‡è®¾ä¸€äº› <strong>CinÃ©polis</strong> å½±é™¢çš„æ“ä½œäººå‘˜å·²ç»ä¸ºå½±é™¢æ’å¥½äº†æ”¾æ˜ è®¡åˆ’ï¼Œè¿™æ ·ä¸€æ¥æˆ‘ä»¬çš„ä»»åŠ¡åªæ˜¯å–è·å–è¿™äº›è®¡åˆ’è€Œå·²ã€‚</p>
<p><strong>å½±é™¢ç›®å½•æœåŠ¡</strong>åªä¸“æ³¨äºå¤„ç†å½±é™¢å’Œæ”¾æ˜ è®¡åˆ’ä¸¤æ–¹é¢çš„æ•°æ®ï¼Œæ²¡æœ‰å…¶å®ƒåŠŸèƒ½ï¼Œä¹‹å‰æˆ‘ä»¬æåˆ°çš„ <strong>locations</strong> æ•°æ®é›†åˆï¼Œæ˜¯å¦ä¸€ä¸ªå¾®æœåŠ¡è´Ÿè´£å¤„ç†çš„ï¼Œä¸è¿‡æ˜¾ç¤ºå½±é™¢å’Œæ”¾æ˜ è®¡åˆ’æ—¶è¿˜æ˜¯è¦ä¾èµ–ä½ç½®ä¿¡æ¯çš„ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»ç¡®è®¤äº†éœ€æ±‚è¾¹ç•Œï¼Œå¯ä»¥åˆ›å»ºæˆ‘ä»¬çš„ RAML æ–‡ä»¶äº†ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#%RAML 1.0</span></div><div class="line"><span class="attr">title:</span> <span class="string">Cinema</span> <span class="string">Catalog</span> <span class="string">Service</span></div><div class="line"><span class="attr">version:</span> <span class="string">v1</span></div><div class="line"><span class="attr">baseUri:</span> <span class="string">/</span></div><div class="line"><span class="attr">uses:</span></div><div class="line"><span class="attr">  object:</span> <span class="string">types.raml</span></div><div class="line"><span class="attr">  stack:</span> <span class="string">../movies-service/api.raml</span></div><div class="line"></div><div class="line"><span class="attr">types:</span></div><div class="line"><span class="attr">  Cinemas:</span> <span class="string">object.Cinema</span> <span class="string">[]</span></div><div class="line"><span class="attr">  Movies:</span> <span class="string">stack.MoviePremieres</span></div><div class="line"><span class="attr">  Schedules:</span> <span class="string">object.Schedule</span> <span class="string">[]</span></div><div class="line"></div><div class="line"><span class="attr">traits:</span></div><div class="line"><span class="attr">  FilterByLocation:</span></div><div class="line"><span class="attr">    queryParameters:</span></div><div class="line"><span class="attr">      city:</span></div><div class="line"><span class="attr">        type:</span> <span class="string">string</span></div><div class="line"></div><div class="line"><span class="attr">resourceTypes:</span></div><div class="line"><span class="attr">  GET:</span></div><div class="line"><span class="attr">    get:</span></div><div class="line"><span class="attr">      responses:</span></div><div class="line">        <span class="number">200</span><span class="string">:</span></div><div class="line"><span class="attr">          body:</span></div><div class="line">            <span class="string">application/json:</span></div><div class="line"><span class="attr">              type:</span> <span class="string">&lt;&lt;item&gt;&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="string">/cinemas:</span></div><div class="line"><span class="attr">  type:</span>  <span class="string">&#123;</span> <span class="attr">GET:</span> <span class="string">&#123;item</span> <span class="string">:</span> <span class="string">Cinemas</span> <span class="string">&#125;</span> <span class="string">&#125;</span></div><div class="line"><span class="attr">  get:</span></div><div class="line"><span class="attr">    is:</span> <span class="string">[FilterByLocation]</span></div><div class="line"><span class="attr">  description:</span> <span class="string">we</span> <span class="string">already</span> <span class="string">have</span> <span class="string">the</span> <span class="string">location</span> <span class="string">defined</span> <span class="string">to</span> <span class="string">display</span> <span class="string">the</span> <span class="string">cinemas</span></div><div class="line"></div><div class="line">  <span class="string">/cinemas/&#123;cinema_id&#125;:</span></div><div class="line"><span class="attr">    type:</span>  <span class="string">&#123;</span> <span class="attr">GET:</span> <span class="string">&#123;item</span> <span class="string">:</span> <span class="string">Movies</span> <span class="string">&#125;</span> <span class="string">&#125;</span></div><div class="line"><span class="attr">    description:</span> <span class="string">we</span> <span class="string">have</span> <span class="string">selected</span> <span class="string">the</span> <span class="string">cinema</span> <span class="string">to</span> <span class="string">display</span> <span class="string">the</span> <span class="string">movie</span> <span class="string">premieres</span></div><div class="line"></div><div class="line">    <span class="string">/cinemas/&#123;cinema_id&#125;/&#123;movie_id&#125;:</span></div><div class="line"><span class="attr">      type:</span>  <span class="string">&#123;</span> <span class="attr">GET:</span> <span class="string">&#123;item</span> <span class="string">:</span> <span class="string">Schedules</span> <span class="string">&#125;</span> <span class="string">&#125;</span></div><div class="line"><span class="attr">      description:</span> <span class="string">we</span> <span class="string">have</span> <span class="string">selceted</span> <span class="string">a</span> <span class="string">movie</span> <span class="string">to</span> <span class="string">display</span> <span class="string">the</span> <span class="string">schedules</span></div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å·²ç»å®ç°äº†ä¸Šé¢å››å¥è¯éœ€æ±‚ä¸­çš„ä¸‰å¥ï¼Œç¬¬ 4 æ¡éœ€æ±‚æ˜¯åœ¨ç”µå½±é™¢è®¢ç¥¨ï¼Œä¸è¿‡å®ƒæ˜¯<strong>è®¢ç¥¨æœåŠ¡</strong>è´Ÿè´£çš„ï¼Œæ‰€ä»¥è¯·ç»§ç»­å…³æ³¨ã€Œç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡ã€ç³»åˆ—çš„åç»­æ–‡ç« ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ç»§ç»­å¼€å‘<strong>å½±é™¢ç›®å½•æœåŠ¡</strong>äº†ï¼Œå®ƒçš„ç»“æ„ä¸é…ç½®å’Œ<strong>ç”µå½±æœåŠ¡</strong>åŸºæœ¬ä¸€æ ·ï¼Œæ‰€ä»¥å…ˆçœ‹ä¸€ä¸‹ API çš„ <strong>repository.js</strong> æ–‡ä»¶ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// more code above</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> getCinemasByCity = <span class="function">(<span class="params">cityId</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> cinemas = []</div><div class="line">      <span class="keyword">const</span> query = &#123;<span class="attr">city_id</span>: cityId&#125;</div><div class="line">      <span class="keyword">const</span> projection = &#123;<span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="number">1</span>&#125;</div><div class="line">      <span class="comment">// example of making a find query to mongoDB, </span></div><div class="line">      <span class="comment">// passign a query and projection objects.</span></div><div class="line">      <span class="keyword">const</span> cursor = db.collection(<span class="string">'cinemas'</span>).find(query, projection)</div><div class="line">      <span class="keyword">const</span> addCinema = <span class="function">(<span class="params">cinema</span>) =&gt;</span> &#123;</div><div class="line">        cinemas.push(cinema)</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">const</span> sendCinemas = <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">if</span> (err) &#123;</div><div class="line">          reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'An error occured fetching cinemas, err: '</span> + err))</div><div class="line">        &#125;</div><div class="line">        resolve(cinemas)</div><div class="line">      &#125;</div><div class="line">      cursor.forEach(addCinema, sendCinemas)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> getCinemaById = <span class="function">(<span class="params">cinemaId</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> query = &#123;<span class="attr">_id</span>: <span class="keyword">new</span> ObjectID(cinemaId)&#125;</div><div class="line">      <span class="keyword">const</span> projection = &#123;<span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">cinemaPremieres</span>: <span class="number">1</span>&#125;</div><div class="line">      <span class="keyword">const</span> response = <span class="function">(<span class="params">err, cinema</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">if</span> (err) &#123;</div><div class="line">          reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'An error occuered retrieving a cinema, err: '</span> + err))</div><div class="line">        &#125;</div><div class="line">        resolve(cinema)</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// example of using findOne method from mongodb, </span></div><div class="line">      <span class="comment">// we do this because we only need one record.</span></div><div class="line">      db.collection(<span class="string">'cinemas'</span>).findOne(query, projection, response)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> getCinemaScheduleByMovie = <span class="function">(<span class="params">options</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> match = &#123; <span class="attr">$match</span>: &#123;</div><div class="line">        <span class="string">'city_id'</span>: options.cityId,</div><div class="line">        <span class="string">'cinemaRooms.schedules.movie_id'</span>: options.movieId</div><div class="line">      &#125;&#125;</div><div class="line">      <span class="keyword">const</span> project = &#123; <span class="attr">$project</span>: &#123;</div><div class="line">        <span class="string">'name'</span>: <span class="number">1</span>,</div><div class="line">        <span class="string">'cinemaRooms.schedules.time'</span>: <span class="number">1</span>,</div><div class="line">        <span class="string">'cinemaRooms.name'</span>: <span class="number">1</span>,</div><div class="line">        <span class="string">'cinemaRooms.format'</span>: <span class="number">1</span></div><div class="line">      &#125;&#125;</div><div class="line">      <span class="keyword">const</span> unwind = [&#123; <span class="attr">$unwind</span>: <span class="string">'$cinemaRooms'</span> &#125;, &#123; <span class="attr">$unwind</span>: <span class="string">'$cinemaRooms.schedules'</span> &#125;]</div><div class="line">      <span class="keyword">const</span> group = [&#123; <span class="attr">$group</span>: &#123;</div><div class="line">        <span class="attr">_id</span>: &#123;</div><div class="line">          <span class="attr">name</span>: <span class="string">'$name'</span>,</div><div class="line">          <span class="attr">room</span>: <span class="string">'$cinemaRooms.name'</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">schedules</span>: &#123; <span class="attr">$addToSet</span>: <span class="string">'$cinemaRooms.schedules.time'</span> &#125;</div><div class="line">      &#125;&#125;, &#123; <span class="attr">$group</span>: &#123;</div><div class="line">        <span class="attr">_id</span>: <span class="string">'$_id.name'</span>,</div><div class="line">        <span class="attr">schedules</span>: &#123;</div><div class="line">          <span class="attr">$addToSet</span>: &#123;</div><div class="line">            <span class="attr">room</span>: <span class="string">'$_id.room'</span>,</div><div class="line">            <span class="attr">schedules</span>: <span class="string">'$schedules'</span></div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;&#125;]</div><div class="line">      <span class="keyword">const</span> sendSchedules = <span class="function">(<span class="params">err, result</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">if</span> (err) &#123;</div><div class="line">          reject(<span class="string">'An error has occured fetching schedules by movie, err: '</span> + err)</div><div class="line">        &#125;</div><div class="line">        resolve(result)</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// example of using a aggregation method from mongoDB</span></div><div class="line">      <span class="comment">// we difine our pipline above, we are using also ES6 spread operator</span></div><div class="line">      db.collection(<span class="string">'cinemas'</span>).aggregate([match, project, ...unwind, ...group], sendSchedules)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>æƒ³è¦æŸ¥çœ‹å®Œæ•´ç‰ˆ <strong>repository.js</strong> æ–‡ä»¶ï¼Œä½ å¯ä»¥å» github ä»“åº“çš„ <em>step-2</em> åˆ†æ”¯é‡Œå»æ‰¾ã€‚</p>
<p>æ­¤æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸‰ä¸ªå‡½æ•°ï¼š</p>
<ul>
<li><strong>getCinemasByCity</strong>: é€šè¿‡æ­¤å‡½æ•°æˆ‘ä»¬å¯ä»¥è·å–åˆ°åŸå¸‚ä¸­æ‰€æœ‰å¯ç”¨çš„ç”µå½±é™¢ï¼Œæˆ‘ä»¬ä¼ å…¥ city_id å‚æ•°ä»¥è·å–ç”µå½±é™¢ä¿¡æ¯ï¼Œå¯ç”¨æ¥è°ƒç”¨ä¸‹ä¸€ä¸ªå‡½æ•°ã€‚</li>
<li><strong>getCinemaById</strong>: æ­¤å‡½æ•°å¯ä»¥é€šè¿‡ cinema_id æŸ¥è¯¢åˆ°ç”µå½±é™¢çš„åç§°ï¼Œidï¼Œä»¥åŠæ­£åœ¨ä¸Šæ˜ çš„ç”µå½±ï¼Œè¿”å›ç»“æœå¯ä»¥å¸®åŠ©æˆ‘ä»¬æœ€ç»ˆè·å–åˆ°ç”µå½±çš„æ”¾æ˜ è®¡åˆ’ã€‚</li>
<li><strong>getCinemaScheduleByMovie</strong>: è¿™ä¸ªå‡½æ•°å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›åŸä¸­æ‰€æœ‰å½±é™¢å…³äºæŸç”µå½±çš„æ”¾æ˜ è®¡åˆ’ã€‚</li>
</ul>
<p>ä¸ºäº†å±•ç¤ºå½“å‰å½±é™¢çš„æ”¾æ˜ è®¡åˆ’ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜éœ€è¦ä¸€ä¸ªå‡½æ•°ï¼Œæˆ–è€…æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸€ä¸‹ <strong>getCinemaById</strong> æ–¹æ³•ï¼Œå¦‚æœä½ ä¹æ„åšä¸ªå°ç»ƒä¹ ï¼Œè¿™æ˜¯ä¸ªä¸é”™çš„æŒ‘æˆ˜ï¼Œç”±äºæˆ‘å·²ç»æä¾›äº†æ‰€æœ‰éœ€è¦çš„ä¿¡æ¯ï¼Œæ‰€ä»¥è¿™åº”è¯¥ä¸ä¼šå¤ªéš¾ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬è¦çœ‹ API æ–‡ä»¶ <strong>cinema-catalog.js</strong>ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">'use strict'</span></div><div class="line"><span class="keyword">const</span> status = <span class="built_in">require</span>(<span class="string">'http-status'</span>)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">app, options</span>) =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> &#123;repo&#125; = options</div><div class="line"></div><div class="line">  app.get(<span class="string">'/cinemas'</span>, (req, res, next) =&gt; &#123;</div><div class="line">    repo.getCinemasByCity(req.query.cityId)</div><div class="line">      .then(<span class="function"><span class="params">cinemas</span> =&gt;</span> &#123;</div><div class="line">        res.status(status.OK).json(cinemas)</div><div class="line">      &#125;)</div><div class="line">      .catch(next)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  app.get(<span class="string">'/cinemas/:cinemaId'</span>, (req, res, next) =&gt; &#123;</div><div class="line">    repo.getCinemaById(req.params.cinemaId)</div><div class="line">      .then(<span class="function"><span class="params">cinema</span> =&gt;</span> &#123;</div><div class="line">        res.status(status.OK).json(cinema)</div><div class="line">      &#125;)</div><div class="line">      .catch(next)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  app.get(<span class="string">'/cinemas/:cityId/:movieId'</span>, (req, res, next) =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> params = &#123;</div><div class="line">      <span class="attr">cityId</span>: req.params.cityId,</div><div class="line">      <span class="attr">movieId</span>: req.params.movieId</div><div class="line">    &#125;</div><div class="line">    repo.getCinemaScheduleByMovie(params)</div><div class="line">      .then(<span class="function"><span class="params">schedules</span> =&gt;</span> &#123;</div><div class="line">        res.status(status.OK).json(schedules)</div><div class="line">      &#125;)</div><div class="line">      .catch(next)</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚ä½ æ‰€è§ï¼Œè¿™é‡Œæˆ‘ä»¬å®ç°äº†æœåŠ¡çš„å…¥å£ï¼Œå’Œæˆ‘ä»¬åœ¨ <strong>RAML</strong> æ–‡ä»¶ä¸­å®šä¹‰çš„ä¸€æ ·ï¼Œæ ¹æ®è·¯ç”±è°ƒç”¨ <code>repository.js</code> ä¸­çš„ä¸åŒæ–¹æ³•ã€‚</p>
<p>åœ¨ç¬¬ä¸€ä¸ªè·¯ç”±ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>req.query.cityId</code> çš„å€¼ä½œä¸ºåŸå¸‚çš„ <code>city_id</code> æŸ¥è¯¢æ•°æ®åº“è·å–åˆ°å½±é™¢ä¿¡æ¯ï¼Œå¦ä¸€ä¸ªè·¯ç”±ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>req.params</code> å¾—åˆ° <code>cinemaId</code> å’Œ <code>movieId</code> çš„å€¼ï¼Œæ¥æŸ¥è¯¢æ”¾æ˜ è®¡åˆ’ <code>schedules</code> ğŸ˜ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>cinema-catalog.spec.js</code> è¿™ä¸ªæµ‹è¯•æ–‡ä»¶ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/* eslint-env mocha */</span></div><div class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'supertest'</span>)</div><div class="line"><span class="keyword">const</span> server = <span class="built_in">require</span>(<span class="string">'../server/server'</span>)</div><div class="line">process.env.NODE = <span class="string">'test'</span></div><div class="line"></div><div class="line">describe(<span class="string">'Movies API'</span>, () =&gt; &#123;</div><div class="line">  <span class="keyword">let</span> app = <span class="literal">null</span></div><div class="line">  <span class="keyword">const</span> testCinemasCity = [&#123;</div><div class="line">    <span class="string">'_id'</span>: <span class="string">'588ac3a02d029a6d15d0b5c4'</span>,</div><div class="line">    <span class="string">'name'</span>: <span class="string">'Plaza Morelia'</span></div><div class="line">  &#125;, &#123;</div><div class="line">    <span class="string">'_id'</span>: <span class="string">'588ac3a02d029a6d15d0b5c5'</span>,</div><div class="line">    <span class="string">'name'</span>: <span class="string">'Las Americas'</span></div><div class="line">  &#125;]</div><div class="line"></div><div class="line">  <span class="keyword">const</span> testCinemaId = &#123;</div><div class="line">    <span class="string">'_id'</span>: <span class="string">'588ac3a02d029a6d15d0b5c4'</span>,</div><div class="line">    <span class="string">'name'</span>: <span class="string">'Plaza Morelia'</span>,</div><div class="line">    <span class="string">'cinemaPremieres'</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">'id'</span>: <span class="string">'1'</span>,</div><div class="line">        <span class="string">'title'</span>: <span class="string">'Assasins Creed'</span>,</div><div class="line">        <span class="string">'runtime'</span>: <span class="number">115</span>,</div><div class="line">        <span class="string">'plot'</span>: <span class="string">'Lorem ipsum dolor sit amet'</span>,</div><div class="line">        <span class="string">'poster'</span>: <span class="string">'link to poster...'</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">'id'</span>: <span class="string">'2'</span>,</div><div class="line">        <span class="string">'title'</span>: <span class="string">'Aliados'</span>,</div><div class="line">        <span class="string">'runtime'</span>: <span class="number">124</span>,</div><div class="line">        <span class="string">'plot'</span>: <span class="string">'Lorem ipsum dolor sit amet'</span>,</div><div class="line">        <span class="string">'poster'</span>: <span class="string">'link to poster...'</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">'id'</span>: <span class="string">'3'</span>,</div><div class="line">        <span class="string">'title'</span>: <span class="string">'xXx: Reactivado'</span>,</div><div class="line">        <span class="string">'runtime'</span>: <span class="number">107</span>,</div><div class="line">        <span class="string">'plot'</span>: <span class="string">'Lorem ipsum dolor sit amet'</span>,</div><div class="line">        <span class="string">'poster'</span>: <span class="string">'link to poster...'</span></div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> testSchedulesMovie = [&#123;</div><div class="line">    <span class="string">'_id'</span>: <span class="string">'Plaza Morelia'</span>,</div><div class="line">    <span class="string">'schedules'</span>: [&#123;</div><div class="line">      <span class="string">'room'</span>: <span class="number">2.0</span>,</div><div class="line">      <span class="string">'schedules'</span>: [ <span class="string">'10:15'</span> ]</div><div class="line">    &#125;, &#123;</div><div class="line">      <span class="string">'room'</span>: <span class="number">1.0</span>,</div><div class="line">      <span class="string">'schedules'</span>: [ <span class="string">'6:55'</span>, <span class="string">'4:35'</span>, <span class="string">'10:15'</span> ]</div><div class="line">    &#125;, &#123;</div><div class="line">      <span class="string">'room'</span>: <span class="number">3.0</span>,</div><div class="line">      <span class="string">'schedules'</span>: [ <span class="string">'10:15'</span> ]</div><div class="line">    &#125;]</div><div class="line">  &#125;, &#123;</div><div class="line">    <span class="string">'_id'</span>: <span class="string">'Las Americas'</span>,</div><div class="line">    <span class="string">'schedules'</span>: [ &#123;</div><div class="line">      <span class="string">'room'</span>: <span class="number">2.0</span>,</div><div class="line">      <span class="string">'schedules'</span>: [ <span class="string">'3:25'</span>, <span class="string">'10:15'</span> ]</div><div class="line">    &#125;, &#123;</div><div class="line">      <span class="string">'room'</span>: <span class="number">1.0</span>,</div><div class="line">      <span class="string">'schedules'</span>: [ <span class="string">'12:15'</span>, <span class="string">'10:15'</span> ]</div><div class="line">    &#125;]</div><div class="line">  &#125;]</div><div class="line"></div><div class="line">  <span class="keyword">let</span> testRepo = &#123;</div><div class="line">    getCinemasByCity (location) &#123;</div><div class="line">      <span class="built_in">console</span>.log(location)</div><div class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(testCinemasCity)</div><div class="line">    &#125;,</div><div class="line">    getCinemaById (cinemaId) &#123;</div><div class="line">      <span class="built_in">console</span>.log(cinemaId)</div><div class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(testCinemaId)</div><div class="line">    &#125;,</div><div class="line">    getCinemaScheduleByMovie (cinemaId, movieId) &#123;</div><div class="line">      <span class="built_in">console</span>.log(cinemaId, movieId)</div><div class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(testSchedulesMovie)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> server.start(&#123;</div><div class="line">      <span class="attr">port</span>: <span class="number">3000</span>,</div><div class="line">      <span class="attr">repo</span>: testRepo</div><div class="line">    &#125;).then(<span class="function"><span class="params">serv</span> =&gt;</span> &#123;</div><div class="line">      app = serv</div><div class="line">    &#125;)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  afterEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    app.close()</div><div class="line">    app = <span class="literal">null</span></div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  it(<span class="string">'can return cinemas by location'</span>, (done) =&gt; &#123;</div><div class="line">    <span class="keyword">const</span> location = &#123;</div><div class="line">      <span class="attr">city</span>: <span class="string">'588ababf2d029a6d15d0b5bf'</span></div><div class="line">    &#125;</div><div class="line">    request(app)</div><div class="line">      .get(<span class="string">`/cinemas?cityId=<span class="subst">$&#123;location.city&#125;</span>`</span>)</div><div class="line">      .expect(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</div><div class="line">        res.body.should.containEql(testCinemasCity[<span class="number">0</span>])</div><div class="line">        res.body.should.containEql(testCinemasCity[<span class="number">1</span>])</div><div class="line">      &#125;)</div><div class="line">      .expect(<span class="number">200</span>, done)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  it(<span class="string">'can get movie premiers by cinema'</span>, (done) =&gt; &#123;</div><div class="line">    request(app)</div><div class="line">    .get(<span class="string">'/cinemas/588ac3a02d029a6d15d0b5c4'</span>)</div><div class="line">    .expect(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</div><div class="line">      res.body.should.containEql(testCinemaId)</div><div class="line">    &#125;)</div><div class="line">    .expect(<span class="number">200</span>, done)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">  it(<span class="string">'can get schedules by cinema and movie'</span>, (done) =&gt; &#123;</div><div class="line">    request(app)</div><div class="line">      .get(<span class="string">'/cinemas/588ababf2d029a6d15d0b5bf/1'</span>)</div><div class="line">      .expect(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</div><div class="line">        res.body.should.containEql(testSchedulesMovie[<span class="number">0</span>])</div><div class="line">        res.body.should.containEql(testSchedulesMovie[<span class="number">1</span>])</div><div class="line">      &#125;)</div><div class="line">      .expect(<span class="number">200</span>, done)</div><div class="line">  &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆæˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ª <code>cinema-catalog-service</code> çš„ docker é•œåƒï¼Œå¹¶ä½¿å…¶åœ¨å®¹å™¨ä¸­è¿è¡Œã€‚æˆ‘ä»¬å°†ä½¿ç”¨å’Œ <strong>movies service</strong> ä¸€æ ·çš„ <code>dockerfile</code> ï¼Œä¸ºäº†ä½¿æ“ä½œè¿‡ç¨‹æ›´åŠ è‡ªåŠ¨åŒ–ä¸€äº›ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª bash è„šæœ¬ <code>start-service.sh</code> å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env bash</span></div><div class="line"><span class="built_in">eval</span> `docker-machine env manager1`</div><div class="line">docker build -t catalog-service .</div><div class="line">docker run --name catalog-service -p 3000:3000 --env-file env <span class="_">-d</span> catalog-service</div></pre></td></tr></table></figure>
<p>ç”±äºæˆ‘ä»¬çš„æœåŠ¡ä¼šä¸æ–­å¢åŠ ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„å¯ä¾›æœåŠ¡ä½¿ç”¨çš„ç«¯å£ï¼Œè¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨ 3000 ç«¯å£ï¼Œå¦å¤–æˆ‘ä¼šä½¿ç”¨ä¸€ä¸ª<strong>ç¯å¢ƒæ–‡ä»¶</strong>ä½¿æˆ‘ä»¬çš„ <strong>NodeJS</strong> æœåŠ¡å¼€å§‹ä½¿ç”¨ <strong>process.env</strong> é…ç½®ï¼Œæˆ‘ä»¬çš„ç¯å¢ƒæ–‡ä»¶çœ‹èµ·æ¥å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">DB=cinemas</div><div class="line">DB_USER=cristian</div><div class="line">DB_PASS=cristianPassword2017</div><div class="line">DB_REPLS=rs1</div><div class="line">DB_SERVERS=&apos;192.168.99.100:27017 192.168.99.101:27017 192.168.99.102:27017&apos;</div><div class="line">PORT=3000</div></pre></td></tr></table></figure>
<p>åœ¨ devOps çš„ä¸–ç•Œä¸­ï¼Œè¿™è¢«è®¤ä¸ºæ˜¯æœ€å¥½çš„åšæ³•ã€‚</p>
<p>æœ€ååªè¦æ‰§è¡Œæˆ‘ä»¬çš„ bash å°è„šæœ¬ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># execute our script</div><div class="line">$ bash &lt; start-service.sh</div><div class="line"># check running docker contianers</div><div class="line">$ docker ps</div></pre></td></tr></table></figure>
<p>åº”è¯¥å¯ä»¥çœ‹åˆ°ç±»ä¼¼ä¸‹å›¾çš„æƒ…å†µï¼š</p>
<p><img src="https://img.zvz.im/imgs/2019/06/9306e91bf244845c.png" alt=""></p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥åœ¨ chrome æµè§ˆå™¨ä¸­æµ‹ä¸€ä¸‹æˆ‘ä»¬çš„æœåŠ¡ï¼ŒéªŒè¯ <strong>HTTP/2</strong> åè®®èƒ½æ­£å¸¸å·¥ä½œï¼Œè€Œä¸”æœåŠ¡ä¹Ÿæ˜¯æ­£å¸¸è¿è¡Œçš„ã€‚</p>
<p><img src="https://img.zvz.im/imgs/2019/06/80065700ac28226e.png" alt=""></p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥æ‰¾ç‚¹ä¹å­ï¼Œä½¿ç”¨ <strong>JMeter</strong> è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼Œå‹æµ‹æ–‡ä»¶ä¹Ÿåœ¨ github ä»“åº“ä¸­çš„ <strong>integration-test/</strong> ç›®å½•ä¸‹ã€‚</p>
<p><img src="https://img.zvz.im/imgs/2019/06/15b430ee5d0b7082.png" alt=""></p>
<p><img src="https://img.zvz.im/imgs/2019/06/89fcb6d89df7cf8a.gif" alt=""></p>
<h2 id="æ€»ç»“æ—¶é—´"><a href="#æ€»ç»“æ—¶é—´" class="headerlink" title="# æ€»ç»“æ—¶é—´"></a># æ€»ç»“æ—¶é—´</h2><p>æˆ‘ä»¬éƒ½åšäº†ä»€ä¹ˆã€‚ã€‚ã€‚</p>
<p><img src="https://img.zvz.im/imgs/2019/06/f142eea98b22201f.png" alt=""></p>
<p>æˆ‘ä»¬å·²ç»å®Œæˆäº†å›¾ä¸­çš„è¿™äº›å¾®æœåŠ¡ï¼Œä½ å¯èƒ½ä¼šè¯´åœ¨<strong>å½±é™¢ç›®å½•æœåŠ¡</strong>ä¸­æˆ‘ä»¬è¿˜æ²¡æœ‰è°ƒç”¨<strong>ç”µå½±æœåŠ¡</strong>ã€‚çš„ç¡®å¦‚æ­¤ï¼Œæˆ‘ä»¬è‡³æ­¤åªå®ç°äº†æœåŠ¡çš„ <strong>GET</strong> è¯·æ±‚å¤„ç†ã€‚è€Œåœ¨<strong>å½±é™¢ç›®å½•æœåŠ¡</strong>ä¸­è°ƒç”¨<strong>ç”µå½±æœåŠ¡</strong>æ—¶ä½¿ç”¨ <strong>POST</strong> è¯·æ±‚ï¼Œæ˜¯ä¸ºäº†ç»™å½±é™¢è¾“å…¥ä¸Šæ˜ çš„ç”µå½±ï¼Œä»¥ä¾¿åˆ¶ä½œæ”¾æ˜ è®¡åˆ’ï¼Œç”±äºæˆ‘ä»¬æœ¬æ¬¡çš„ä»»åŠ¡åªæ˜¯ <strong>CRUD</strong> æ“ä½œä¸­çš„ <strong>R</strong> è¯»æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ²¡æœ‰çœ‹åˆ°è¿™ä¸ªäº¤äº’ã€‚ä¸è¿‡åœ¨æœ¬ç³»åˆ—çš„åç»­æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šåœ¨å¾®æœåŠ¡ä¸­å®ç°æ›´å¤šçš„ CRUD æ“ä½œï¼Œè¯·ä¿æŒè€å¿ƒå’Œå¥½å¥‡å¿ƒ :D ã€‚</p>
<p>é‚£ä¹ˆæœ¬ç« ä¸­æˆ‘ä»¬åšäº†ä»€ä¹ˆ Â¿ ğŸ¤” ?ï¼Œæˆ‘ä»¬å­¦ä¹ äº† <strong>HTTP/2</strong> åè®®å¹¶ä¸”åœ¨<strong>å¾®æœåŠ¡</strong>ä¸­å®ç°äº†å®ƒã€‚æˆ‘ä»¬è¿˜çœ‹åˆ°äº†å¦‚ä½•<strong>è®¾è®¡ä¸€ä¸ª MongoDB æ¨¡å‹</strong>ï¼Œè™½ç„¶å¹¶ä¸æ·±å…¥ä½†æ˜¯æˆ‘çªå‡ºäº†è¿™ä¸ªéƒ¨åˆ†ï¼Œå¹¶è¯¦ç»†æç»˜äº†<strong>å½±é™¢ç›®å½•æœåŠ¡</strong>è®¾è®¡ä¸­å‘ç”Ÿäº†ä»€ä¹ˆï¼Œç„¶åæˆ‘ä»¬ç”¨ <strong>RAML</strong> è®¾è®¡äº† API æ¥å£ï¼Œæ¥ç€å®ç° API æœåŠ¡ï¼Œä¹‹ååšäº†ç›¸åº”çš„<strong>å•å…ƒæµ‹è¯•</strong>ï¼Œæœ€åæˆ‘ä»¬æŠŠè¿™äº›éƒ½ç»„è£…èµ·æ¥å®Œæˆäº†å¾®æœåŠ¡ã€‚</p>
<p>å…¶æ¬¡æˆ‘ä»¬ä½¿ç”¨äº†ä¸ä¹‹å‰çš„<strong>å¾®æœåŠ¡</strong>ä¸€æ ·çš„ <strong>dockerfile</strong>ï¼Œå¹¶æ„å»ºäº†ä¸€ä¸ªè„šæœ¬æ¥è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿˜ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ç¯å¢ƒæ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨ <strong>Docker</strong> å®¹å™¨ä¸­ä½¿ç”¨ <code>environment variables</code>ï¼Œåœ¨å®Œæˆè¿™äº›ä¹‹åï¼Œä½œä¸º<strong>é›†æˆæµ‹è¯•</strong>çš„è¡¥å……ï¼Œæˆ‘è¿˜å‘ä½ ä»¬å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ JMeter è¿›è¡Œ<strong>å‹åŠ›æµ‹è¯•</strong>ã€‚</p>
<p>è™½ç„¶æˆ‘ä»¬å¯èƒ½è§è¿‡è®¸å¤š <strong>NodeJS</strong> å¼€å‘çš„é¡¹ç›®ï¼Œä¸è¿‡ä»ç„¶è¿˜æœ‰è®¸å¤šä¸œè¥¿å€¼å¾—æˆ‘ä»¬å»å­¦ä¹ å’Œå®è·µã€‚æœ¬æ–‡åªæ˜¯ä¸€ä¸ªå°å°çš„å±•ç¤ºï¼Œæˆ‘å¸Œæœ›å®ƒå±•ç¤ºå‡ºäº†ä¸€äº›æœ‰è¶£è€Œæœ‰ç”¨çš„ä¸œè¥¿ï¼Œä½¿ä½ åœ¨å·¥ä½œä¸­èƒ½å¤Ÿè¿ç”¨ <strong>Docker å’Œ NodeJS</strong> çš„ç›¸å…³æŠ€æœ¯ã€‚</p>
<p>ç¿»è¯‘è‡ªï¼š<a href="https://medium.com/@cramirez92/build-a-nodejs-cinema-microservice-and-deploying-it-with-docker-part-2-e05cc7b126e0" target="_blank" rel="external">Build a NodeJS cinema microservice and deploying it with docker (part 2)</a></p>
<p><a href="https://log.zvz.im/2017/05/24/nodejs-cinema-microservice-part1/">ç³»åˆ—æ–‡ç«  - Part 1</a></p>

      

      
        
    </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/10/17/nodejs-cinema-microservice-part3/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          ç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡å¹¶éƒ¨ç½²åˆ° docker ä¸Š â€” Part 3
        
      </div>
    </a>
  
  
    <a href="/2017/05/24/nodejs-cinema-microservice-part1/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">ç”¨ NodeJS æ‰“é€ å½±é™¢å¾®æœåŠ¡å¹¶éƒ¨ç½²åˆ° docker ä¸Š â€” Part 1</div>
    </a>
  
</nav>

  
</article>

<script type='text/javascript'>window.notIndexPage = true;</script>


<section id="comments">
  <div id="disqus_thread">
    <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'imzvz'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>
    Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
  </div>
</section>
</section>
        <aside id="sidebar">
  <nav class="menus">
  	<ul>
  		<li><a href="/"><i class="icon icon-home"></i></a></li>
  		
			<li><a href="/archives"><i class="icon icon-fenlei"></i></a></li>
  		
  		
			<li><a href="/tags"><i class="icon icon-tag"></i></a></li>
  		
  		
  	</ul>
  </nav>
  <a id="go-top" href="#"><i class="icon icon-up"></i></a>
</aside>
      </div>
      <footer id="footer">
  
	<div id="footer-info" class="inner">
	Linked with:&nbsp;&nbsp;&nbsp; 
	<a href="http://mritd.me" target="_blank">mritd.me</a>&nbsp;&nbsp;&nbsp;
	<a href="https://www.mghio.cn" target="_blank">mghio's blog</a>&nbsp;&nbsp;&nbsp;
	<a href="https://sillydong.com" target="_blank">å‚»ä¸œã®å­¦ä¹ ç¬”è®°</a>&nbsp;&nbsp;&nbsp;
	</div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/tags" class="mobile-nav-link">Tag</a>
  
</nav>
    
<script>
  var disqus_shortname = 'imzvz';
  
  var disqus_url = 'http://log.zvz.im/2017/07/17/nodejs-cinema-microservice-part2/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>

<script>
  if(window.notIndexPage)
  $(function(){
    $.get('//manage.zvz.im/api/posts/adv', function(res) {
      if(res.data.length) {
        $.each(res.data, function(idx, adv) {
          if(idx == 0) {
            if($('h2:first').length > 0) {
              $(adv).insertBefore('h2:first');
              return;
            }
          }
          $(adv).insertAfter('.article-inner');
        });
      }
    });
  });
</script>



  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/require.min.js"></script>
<script src="/js/script.js"></script>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>



  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>